<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acuity Scheduling by Xtracut - Analytics Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="../../js/lib/jquery-3.3.1.min.js"></script>
    <script src="../../js/lib/ZohoEmbededAppSDK.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'theme-bg-primary': 'var(--bg-primary)',
                        'theme-bg-secondary': 'var(--bg-secondary)',
                        'theme-bg-accent': 'var(--bg-accent)',
                        'theme-text-primary': 'var(--text-primary)',
                        'theme-text-secondary': 'var(--text-secondary)',
                        'theme-border': 'var(--border-color)',
                        'theme-primary': 'var(--color-primary)',
                        'theme-secondary': 'var(--color-secondary)',
                        'theme-accent': 'var(--color-accent)',

                        primary: {
                            50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a',
                        },
                        success: {
                            50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac', 400: '#4ade80', 500: '#22c55e', 600: '#16a34a', 700: '#15803d', 800: '#166534', 900: '#14532d',
                        },
                        warning: {
                            50: '#fff7ed', 100: '#ffedd5', 200: '#fed7aa', 300: '#fdba74', 400: '#fb923c', 500: '#f97316', 600: '#ea580c', 700: '#c2410c', 800: '#9a3412', 900: '#7c2d12',
                        },
                        danger: {
                            50: '#fef2f2', 100: '#fee2e2', 200: '#fecaca', 300: '#fca5a5', 400: '#f87171', 500: '#ef4444', 600: '#dc2626', 700: '#b91c1c', 800: '#991b1b', 900: '#7f1d1d',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 1px 3px 0 rgba(0, 0, 0, 0.1)',
                        'card-hover': '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                        'elegant': '0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            /* Light Theme Variables */
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-accent: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border-color: #e5e7eb;
        }

        html.dark {
            /* Dark Theme Variables */
            --bg-primary: #1f2937;
            --bg-secondary: #111827;
            --bg-accent: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #374151;
        }
        
        /* Default Color Theme (Blue) */
        :root {
            --color-primary: #3b82f6;
            --color-secondary: #60a5fa;
            --color-accent: #2563eb;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .animate-fade-in { animation: fadeIn 0.6s ease-out; }
        .animate-slide-in { animation: slideIn 0.5s ease-out; }
        .animate-pulse-custom { animation: pulse 2s infinite; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        
        html.dark .glass-effect {
            background: rgba(31, 41, 55, 0.98);
            border: 1px solid rgba(55, 65, 81, 0.8);
        }
        
        .gradient-border {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2px;
            border-radius: 16px;
        }
        
        .gradient-border-content {
            background: var(--bg-primary);
            border-radius: 14px;
        }
        
        .chart-container {
            position: relative;
            height: 320px;
            width: 100%;
        }
        
        .metric-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
        }
        
        .modern-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }
        
        .modern-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        html.dark .modern-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        
        .btn-modern {
            background: var(--color-primary);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            padding: 10px 20px;
            transition: all 0.2s ease;
        }
        
        .btn-modern:hover {
            background: var(--color-accent);
        }
        
        .btn-view-more {
            background: var(--bg-accent);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-weight: 500;
            padding: 8px 16px;
            transition: all 0.2s ease;
        }
        
        .btn-view-more:hover {
            background: var(--bg-primary);
            border-color: var(--color-primary);
            color: var(--color-primary);
        }
        
        .card-hover-effect {
            transition: all 0.2s ease;
        }
        
        .card-hover-effect:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        html.dark .card-hover-effect:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .loading-placeholder {
            background: linear-gradient(90deg, var(--bg-accent) 25%, var(--bg-primary) 50%, var(--bg-accent) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
    </style>
    <script>
        // Enhanced Global Data Structure
        let dashboardData = {
            appointmentTypes: [],
            upcomingAppointments: [],
            pastAppointments: [],
            userData: {},
            services: [],
            analytics: {},
            isDataLoaded: false
        };

        // Analytics Configuration
        const analyticsConfig = {
            charts: {},
            colors: {
                primary: '#0ea5e9',
                success: '#22c55e',
                warning: '#f59e0b',
                danger: '#ef4444',
                purple: '#a855f7',
                teal: '#14b8a6',
                orange: '#f97316',
                pink: '#ec4899',
                indigo: '#6366f1'
            }
        };

        // Theme Configuration
        const themeConfig = {
            colors: {
                blue: { primary: '#3b82f6', secondary: '#60a5fa', accent: '#2563eb' },
                purple: { primary: '#8b5cf6', secondary: '#a78bfa', accent: '#7c3aed' },
                green: { primary: '#10b981', secondary: '#34d399', accent: '#059669' },
                orange: { primary: '#f97316', secondary: '#fb923c', accent: '#ea580c' },
                red: { primary: '#ef4444', secondary: '#f87171', accent: '#dc2626' },
                teal: { primary: '#14b8a6', secondary: '#5eead4', accent: '#0d9488' },
                pink: { primary: '#ec4899', secondary: '#f472b6', accent: '#db2777' },
                indigo: { primary: '#6366f1', secondary: '#818cf8', accent: '#4f46e5' }
            }
        };

        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            localStorage.setItem('dashboard_theme', theme);
            updateChartsTheme();
        }

        function applyThemeColor(colorName) {
            const color = themeConfig.colors[colorName];
            if (!color) return;

            const root = document.documentElement;
            root.style.setProperty('--color-primary', color.primary);
            root.style.setProperty('--color-secondary', color.secondary);
            root.style.setProperty('--color-accent', color.accent);
            localStorage.setItem('dashboard_theme_color', colorName);
            updateChartsTheme();
            addThemeSwitcher(); // Re-render to update active color
        }

        function toggleTheme() {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme);
            addThemeSwitcher(); // Re-render to update toggle state
        }
        
        function initializeTheme() {
            const savedTheme = localStorage.getItem('dashboard_theme') || 'light';
            const savedColor = localStorage.getItem('dashboard_theme_color') || 'blue';
            applyTheme(savedTheme);
            applyThemeColor(savedColor);
        }

        function updateChartsTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : '#e5e7eb';
            const textColor = isDark ? '#d1d5db' : '#6b7280';
            const tooltipBg = isDark ? '#111827' : '#ffffff';
            const tooltipText = isDark ? '#f9fafb' : '#111827';
            const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--color-primary').trim();

            Object.values(analyticsConfig.charts).forEach(chart => {
                if (!chart || !chart.options || !chart.options.scales) return;
                
                if (chart.options.scales.x) {
                    chart.options.scales.x.grid.color = gridColor;
                    chart.options.scales.x.ticks.color = textColor;
                }
                if (chart.options.scales.y) {
                    chart.options.scales.y.grid.color = gridColor;
                    chart.options.scales.y.ticks.color = textColor;
                }

                if(chart.options.plugins.tooltip) {
                    chart.options.plugins.tooltip.backgroundColor = tooltipBg;
                    chart.options.plugins.tooltip.titleColor = tooltipText;
                    chart.options.plugins.tooltip.bodyColor = tooltipText;
                }
                
                // Update chart colors based on theme
                if (chart.config.type === 'line' && chart.data.datasets[0]) {
                    chart.data.datasets[0].borderColor = primaryColor;
                    chart.data.datasets[0].backgroundColor = `${primaryColor}33`;
                    chart.data.datasets[0].pointBackgroundColor = primaryColor;
                }
                
                if (chart.config.type === 'bar' && chart.data.datasets[0]) {
                    chart.data.datasets[0].backgroundColor = `${primaryColor}80`;
                    chart.data.datasets[0].borderColor = primaryColor;
                }

                // Update doughnut chart colors
                if (chart.config.type === 'doughnut' && chart.data.datasets[0]) {
                    const colors = [
                        primaryColor,
                        analyticsConfig.colors.success,
                        analyticsConfig.colors.warning,
                        analyticsConfig.colors.purple,
                        analyticsConfig.colors.teal
                    ];
                    chart.data.datasets[0].backgroundColor = colors;
                }

                // Update pie chart colors
                if (chart.config.type === 'pie' && chart.data.datasets[0]) {
                    chart.data.datasets[0].backgroundColor = [
                        analyticsConfig.colors.success,
                        primaryColor,
                        analyticsConfig.colors.danger
                    ];
                }

                chart.update();
            });
        }

        function addThemeSwitcher() {
            const container = document.getElementById('theme-switcher-container');
            if (!container) return;
            
            const isDark = document.documentElement.classList.contains('dark');
            const currentColor = localStorage.getItem('dashboard_theme_color') || 'blue';

            container.innerHTML = `
                <div class="fixed bottom-5 right-5 z-50">
                    <div id="theme-menu" class="absolute bottom-full right-0 mb-2 w-56 bg-theme-bg-primary rounded-lg shadow-2xl border border-theme-border p-4 z-50 hidden transition-all duration-300 opacity-0 -translate-y-2">
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-theme-text-primary">Theme Mode</span>
                                <button onclick="toggleTheme()" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors focus:outline-none focus:ring-2 focus:ring-theme-primary focus:ring-offset-2 focus:ring-offset-theme-bg-primary ${isDark ? 'bg-theme-primary' : 'bg-gray-300'}">
                                    <span class="sr-only">Toggle theme</span>
                                    <span class="material-icons text-xs absolute transition-opacity duration-200 ${isDark ? 'right-1 opacity-100' : 'right-1 opacity-0'}" style="color: #fbbf24;">dark_mode</span>
                                    <span class="material-icons text-xs absolute transition-opacity duration-200 ${!isDark ? 'left-1 opacity-100' : 'left-1 opacity-0'}" style="color: #f59e0b;">light_mode</span>
                                    <span class="inline-block w-4 h-4 transform transition-transform duration-200 bg-white rounded-full shadow ${isDark ? 'translate-x-6' : 'translate-x-1'}"></span>
                                </button>
                            </div>
                            <div class="space-y-2">
                                <span class="text-sm font-medium text-theme-text-primary">Color Theme</span>
                                <div class="grid grid-cols-4 gap-2">
                                    ${Object.keys(themeConfig.colors).map(name => `
                                        <button onclick="applyThemeColor('${name}')" 
                                                class="relative w-8 h-8 rounded-full transition-all duration-200 transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-theme-primary focus:ring-offset-theme-bg-primary ${currentColor === name ? 'ring-2 ring-offset-2 ring-white ring-offset-theme-bg-primary scale-110' : ''}"
                                                style="background-color: ${themeConfig.colors[name].primary}"
                                                title="${name.charAt(0).toUpperCase() + name.slice(1)}">
                                            ${currentColor === name ? '<span class="absolute inset-0 flex items-center justify-center"><span class="material-icons text-white text-sm">check</span></span>' : ''}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                     <button id="theme-menu-button" class="bg-theme-primary text-white rounded-full p-3 shadow-lg hover:shadow-xl hover:bg-theme-accent transition-all duration-300 flex items-center justify-center transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-theme-primary focus:ring-offset-2 focus:ring-offset-theme-bg-secondary">
                        <span class="material-icons">palette</span>
                    </button>
                </div>
            `;

            const menuButton = document.getElementById('theme-menu-button');
            const themeMenu = document.getElementById('theme-menu');
            
            if (menuButton && themeMenu) {
                menuButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (themeMenu.classList.contains('hidden')) {
                        themeMenu.classList.remove('hidden');
                        setTimeout(() => {
                            themeMenu.classList.remove('opacity-0', '-translate-y-2');
                        }, 10);
                    } else {
                        themeMenu.classList.add('opacity-0', '-translate-y-2');
                        setTimeout(() => {
                            themeMenu.classList.add('hidden');
                        }, 300);
                    }
                });

                document.addEventListener('click', (e) => {
                    if (!themeMenu.classList.contains('hidden') && !themeMenu.contains(e.target) && !menuButton.contains(e.target)) {
                        themeMenu.classList.add('opacity-0', '-translate-y-2');
                        setTimeout(() => {
                            themeMenu.classList.add('hidden');
                        }, 300);
                    }
                });
            }
        }

        // Initialize Dashboard
        document.addEventListener("DOMContentLoaded", function() {
            initializeTheme();
            addThemeSwitcher();
            ZOHO.embeddedApp.init()
                .then(function() {
                    console.log("ZOHO SDK initialized successfully");
                    initializeDashboard();
                })
                .catch(function(error) {
                    console.error("Error initializing dashboard:", error);
                    showErrorState();
                });
        });

        // Enhanced Dashboard Initialization - FIXED
        async function initializeDashboard() {
            try {
                showLoadingState();
                await loadAndProcessData();
                
                // Set data as loaded BEFORE rendering
                dashboardData.isDataLoaded = true;
                
                renderDashboard();
                setTimeout(() => {
                    initializeCharts();
                    // Remove loading states after charts are initialized
                    document.querySelectorAll('.loading-placeholder').forEach(el => {
                        el.classList.add('hidden');
                    });
                }, 500);
            } catch (error) {
                console.error("Error initializing dashboard:", error);
                showErrorState();
            }
        }

        // FIXED Load and Process All Data
        async function loadAndProcessData() {
            try {
                console.log("Loading dashboard data...");
                
                // Load data into global object directly from localStorage
                dashboardData.appointmentTypes = JSON.parse(localStorage.getItem('appointmentTypes') || '[]');
                dashboardData.upcomingAppointments = JSON.parse(localStorage.getItem('upcomingAppointments') || '[]');
                dashboardData.pastAppointments = JSON.parse(localStorage.getItem('pastAppointments') || '[]');
                dashboardData.userData = JSON.parse(localStorage.getItem('userData') || '{}');

                // If no essential data, try to fetch from API
                if (dashboardData.appointmentTypes.length === 0 && dashboardData.upcomingAppointments.length === 0 && dashboardData.pastAppointments.length === 0) {
                    console.log("No stored data found, fetching from API...");
                    await fetchAllData();
                    // Reload after fetching
                    dashboardData.appointmentTypes = JSON.parse(localStorage.getItem('appointmentTypes') || '[]');
                    dashboardData.upcomingAppointments = JSON.parse(localStorage.getItem('upcomingAppointments') || '[]');
                    dashboardData.pastAppointments = JSON.parse(localStorage.getItem('pastAppointments') || '[]');
                    dashboardData.userData = JSON.parse(localStorage.getItem('userData') || '{}');
                }

                // Process and store services
                processAndStoreServices();
                
                // Generate analytics
                generateAnalytics();

                console.log("Dashboard data loaded successfully:", dashboardData);
            } catch (error) {
                console.error("Error loading dashboard data:", error);
                throw error;
            }
        }

        // Process and Store Services Separately
        function processAndStoreServices() {
            const services = dashboardData.appointmentTypes.map(type => ({
                id: type.id,
                name: type.name,
                category: type.category || 'General',
                duration: type.duration,
                price: parseFloat(type.price),
                color: type.color || analyticsConfig.colors.primary,
                active: type.active,
                bookingCount: 0,
                revenue: 0,
                lastBooked: null
            }));

            // Calculate booking statistics
            const allAppointments = [...dashboardData.pastAppointments, ...dashboardData.upcomingAppointments];
            
            allAppointments.forEach(appointment => {
                const service = services.find(s => s.id === appointment.appointmentTypeID);
                if (service && !appointment.canceled) {
                    service.bookingCount++;
                    service.revenue += parseFloat(appointment.priceSold || appointment.price || 0);
                    if (!service.lastBooked || new Date(appointment.datetime) > new Date(service.lastBooked)) {
                        service.lastBooked = appointment.datetime;
                    }
                }
            });

            dashboardData.services = services;
            localStorage.setItem('services', JSON.stringify(services));
        }

        // Generate Comprehensive Analytics
        function generateAnalytics() {
            const analytics = {
                overview: calculateOverviewMetrics(),
                revenue: calculateRevenueAnalytics(),
                services: calculateServiceAnalytics(),
                appointments: calculateAppointmentAnalytics(),
                clients: calculateClientAnalytics(),
                trends: calculateTrendAnalytics()
            };

            dashboardData.analytics = analytics;
            console.log("Analytics generated:", analytics);
        }

        // Calculate Overview Metrics
        function calculateOverviewMetrics() {
            const now = new Date();
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const thisWeek = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);

            return {
                totalAppointments: dashboardData.pastAppointments.length + dashboardData.upcomingAppointments.length,
                completedAppointments: dashboardData.pastAppointments.filter(apt => !apt.canceled).length,
                canceledAppointments: dashboardData.pastAppointments.filter(apt => apt.canceled).length,
                upcomingAppointments: dashboardData.upcomingAppointments.length,
                todayAppointments: dashboardData.upcomingAppointments.filter(apt => 
                    new Date(apt.datetime).toDateString() === today.toDateString()
                ).length,
                thisWeekAppointments: dashboardData.pastAppointments.filter(apt => 
                    new Date(apt.datetime) >= thisWeek && !apt.canceled
                ).length,
                activeServices: dashboardData.services.filter(service => service.active).length,
                totalServices: dashboardData.services.length,
                totalRevenue: dashboardData.pastAppointments
                    .filter(apt => !apt.canceled)
                    .reduce((total, apt) => total + parseFloat(apt.priceSold || apt.price || 0), 0),
                monthlyRevenue: dashboardData.pastAppointments
                    .filter(apt => new Date(apt.datetime) >= thisMonth && !apt.canceled)
                    .reduce((total, apt) => total + parseFloat(apt.priceSold || apt.price || 0), 0),
                cancellationRate: dashboardData.pastAppointments.length > 0 
                    ? (dashboardData.pastAppointments.filter(apt => apt.canceled).length / dashboardData.pastAppointments.length * 100)
                    : 0
            };
        }

        // Calculate Revenue Analytics
        function calculateRevenueAnalytics() {
            const revenueByMonth = {};
            const revenueByService = {};

            dashboardData.pastAppointments
                .filter(apt => !apt.canceled)
                .forEach(apt => {
                    const date = new Date(apt.datetime);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const revenue = parseFloat(apt.priceSold || apt.price || 0);

                    revenueByMonth[monthKey] = (revenueByMonth[monthKey] || 0) + revenue;
                    revenueByService[apt.type] = (revenueByService[apt.type] || 0) + revenue;
                });

            return {
                byMonth: revenueByMonth,
                byService: revenueByService,
                topServices: Object.entries(revenueByService)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5)
            };
        }

        // Calculate Service Analytics
        function calculateServiceAnalytics() {
            const serviceStats = dashboardData.services.map(service => {
                const appointments = [...dashboardData.pastAppointments, ...dashboardData.upcomingAppointments]
                    .filter(apt => apt.appointmentTypeID === service.id && !apt.canceled);

                return {
                    ...service,
                    totalBookings: appointments.length,
                    completedBookings: dashboardData.pastAppointments
                        .filter(apt => apt.appointmentTypeID === service.id && !apt.canceled).length,
                    upcomingBookings: dashboardData.upcomingAppointments
                        .filter(apt => apt.appointmentTypeID === service.id && !apt.canceled).length,
                    averageRevenue: appointments.length > 0 
                        ? service.revenue / appointments.length 
                        : 0
                };
            });

            return {
                all: serviceStats,
                popular: serviceStats.sort((a, b) => b.totalBookings - a.totalBookings).slice(0, 5),
                profitable: serviceStats.sort((a, b) => b.revenue - a.revenue).slice(0, 5)
            };
        }

        // Calculate Appointment Analytics
        function calculateAppointmentAnalytics() {
            const hourlyDistribution = Array(24).fill(0);
            const dayDistribution = Array(7).fill(0);
            const statusDistribution = { completed: 0, canceled: 0, upcoming: 0 };

            [...dashboardData.pastAppointments, ...dashboardData.upcomingAppointments].forEach(apt => {
                const date = new Date(apt.datetime);
                hourlyDistribution[date.getHours()]++;
                dayDistribution[date.getDay()]++;

                if (apt.canceled) {
                    statusDistribution.canceled++;
                } else if (dashboardData.pastAppointments.includes(apt)) {
                    statusDistribution.completed++;
                } else {
                    statusDistribution.upcoming++;
                }
            });

            return {
                hourlyDistribution,
                dayDistribution,
                statusDistribution,
                peakHour: hourlyDistribution.indexOf(Math.max(...hourlyDistribution)),
                peakDay: dayDistribution.indexOf(Math.max(...dayDistribution))
            };
        }

        // Enhanced Calculate Client Analytics - Fixed to show all clients
        function calculateClientAnalytics() {
            const clients = new Map();

            [...dashboardData.pastAppointments, ...dashboardData.upcomingAppointments].forEach(apt => {
                const clientKey = `${apt.firstName} ${apt.lastName}`.trim();
                if (!clients.has(clientKey)) {
                    clients.set(clientKey, {
                        name: clientKey,
                        phone: apt.phone,
                        email: apt.email,
                        appointments: [],
                        totalSpent: 0,
                        lastVisit: null
                    });
                }

                const client = clients.get(clientKey);
                client.appointments.push(apt);
                if (!apt.canceled) {
                    client.totalSpent += parseFloat(apt.priceSold || apt.price || 0);
                }
                if (!client.lastVisit || new Date(apt.datetime) > new Date(client.lastVisit)) {
                    client.lastVisit = apt.datetime;
                }
            });

            const clientArray = Array.from(clients.values());

            return {
                totalClients: clientArray.length,
                allClients: clientArray.sort((a, b) => b.totalSpent - a.totalSpent), // All clients sorted by spending
                topClients: clientArray.sort((a, b) => b.totalSpent - a.totalSpent).slice(0, 10),
                repeatClients: clientArray.filter(client => client.appointments.length > 1).length,
                averageSpentPerClient: clientArray.reduce((sum, client) => sum + client.totalSpent, 0) / clientArray.length || 0
            };
        }

        // Calculate Trend Analytics
        function calculateTrendAnalytics() {
            const monthlyTrends = {};
            const serviceTrends = {};

            [...dashboardData.pastAppointments, ...dashboardData.upcomingAppointments]
                .filter(apt => !apt.canceled)
                .forEach(apt => {
                    const date = new Date(apt.datetime);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

                    if (!monthlyTrends[monthKey]) {
                        monthlyTrends[monthKey] = { appointments: 0, revenue: 0 };
                    }
                    if (!serviceTrends[apt.type]) {
                        serviceTrends[apt.type] = {};
                    }
                    if (!serviceTrends[apt.type][monthKey]) {
                        serviceTrends[apt.type][monthKey] = 0;
                    }

                    monthlyTrends[monthKey].appointments++;
                    monthlyTrends[monthKey].revenue += parseFloat(apt.priceSold || apt.price || 0);
                    serviceTrends[apt.type][monthKey]++;
                });

            return {
                monthly: monthlyTrends,
                services: serviceTrends
            };
        }

        // Fetch All Data from API
        async function fetchAllData() {
            try {
                console.log("Fetching all data from API...");
                
                const [appointmentTypesResult, appointmentsResult, userDataResult] = await Promise.all([
                    fetchAndStoreAppointmentTypes().catch(e => {
                        console.error("Failed to fetch appointment types:", e);
                        return [];
                    }),
                    fetchAndStoreAppointments().catch(e => {
                        console.error("Failed to fetch appointments:", e);
                        return { pastAppointments: [], upcomingAppointments: [] };
                    }),
                    fetchAndStoreUserData().catch(e => {
                        console.error("Failed to fetch user data:", e);
                        return {};
                    })
                ]);

                console.log("All data fetched successfully");
                return true;
            } catch (error) {
                console.error("Error in fetchAllData:", error);
                throw error;
            }
        }

        // Render Complete Dashboard - UPDATED to remove fake buttons
        function renderDashboard() {
            const mainContent = document.querySelector('main');
            if (mainContent) {
                mainContent.innerHTML = `
                    <div class="max-w-7xl mx-auto space-y-8 animate-fade-in">
                        <!-- Modern Header Section -->
                        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between glass-effect rounded-2xl p-6 border-l-4 border-theme-primary">
                            <div class="animate-slide-in">
                                <h1 class="text-4xl font-bold bg-gradient-to-r from-theme-text-primary to-theme-text-secondary bg-clip-text text-transparent mb-3">
                                    Analytics Dashboard
                                </h1>
                                <p class="text-theme-text-secondary text-lg">Comprehensive insights for ${dashboardData.userData.name || 'your business'}</p>
                            </div>
                            <div class="mt-6 lg:mt-0 flex items-center space-x-4">
                                <button onclick="refreshDashboard()" class="btn-modern inline-flex items-center">
                                    <span class="material-icons text-sm mr-2">refresh</span>
                                    Refresh Data
                                </button>
                                <button onclick="exportDashboardReport()" class="btn-modern inline-flex items-center bg-gradient-to-r from-emerald-500 to-emerald-600">
                                    <span class="material-icons text-sm mr-2">download</span>
                                    Export Report
                                </button>
                                <button onclick="openAnonymousScheduling()" class="btn-modern inline-flex items-center bg-gradient-to-r from-blue-500 to-blue-600">
                                    <span class="material-icons text-sm mr-2">calendar_today</span>
                                    Schedule
                                </button>
                            </div>
                        </div>

                        <!-- Enhanced Key Metrics Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="keyMetrics">
                            <!-- Loading placeholders -->
                            ${!dashboardData.isDataLoaded ? Array(4).fill(0).map(() => `
                                <div class="loading-placeholder h-32 rounded-2xl"></div>
                            `).join('') : ''}
                        </div>

                        <!-- Modern Charts Section -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Revenue Chart -->
                            <div class="modern-card rounded-lg p-6">
                                <div class="flex items-center justify-between mb-6">
                                    <div>
                                        <h3 class="text-lg font-semibold text-theme-text-primary">Revenue Overview</h3>
                                        <p class="text-sm text-theme-text-secondary">Monthly revenue trends</p>
                                    </div>
                                    <select id="revenueChartPeriod" class="text-sm border border-theme-border rounded-lg px-3 py-2 bg-theme-bg-primary text-theme-text-primary focus:ring-2 focus:ring-theme-primary focus:border-transparent">
                                        <option value="6months">Last 6 Months</option>
                                        <option value="12months">Last 12 Months</option>
                                        <option value="all">All Time</option>
                                    </select>
                                </div>
                                <div class="chart-container">
                                    ${!dashboardData.isDataLoaded ? '<div class="loading-placeholder h-full rounded-lg"></div>' : '<canvas id="revenueChart"></canvas>'}
                                </div>
                            </div>

                            <!-- Service Performance Chart -->
                            <div class="modern-card rounded-lg p-6">
                                <div class="flex items-center justify-between mb-6">
                                    <div>
                                        <h3 class="text-lg font-semibold text-theme-text-primary">Service Performance</h3>
                                        <p class="text-sm text-theme-text-secondary">Top 5 Services by bookings</p>
                                    </div>
                                </div>
                                <div class="chart-container">
                                    ${!dashboardData.isDataLoaded ? '<div class="loading-placeholder h-full rounded-lg"></div>' : '<canvas id="serviceChart"></canvas>'}
                                </div>
                            </div>

                            <!-- Appointment Status Distribution -->
                            <div class="modern-card rounded-lg p-6">
                                <div class="flex items-center justify-between mb-6">
                                    <div>
                                        <h3 class="text-lg font-semibold text-theme-text-primary">Appointment Status</h3>
                                        <p class="text-sm text-theme-text-secondary">Overall distribution</p>
                                    </div>
                                </div>
                                <div class="chart-container">
                                    ${!dashboardData.isDataLoaded ? '<div class="loading-placeholder h-full rounded-lg"></div>' : '<canvas id="statusChart"></canvas>'}
                                </div>
                            </div>

                            <!-- Peak Hours Chart -->
                            <div class="modern-card rounded-lg p-6">
                                <div class="flex items-center justify-between mb-6">
                                    <div>
                                        <h3 class="text-lg font-semibold text-theme-text-primary">Peak Booking Hours</h3>
                                        <p class="text-sm text-theme-text-secondary">24-Hour distribution</p>
                                    </div>
                                </div>
                                <div class="chart-container">
                                    ${!dashboardData.isDataLoaded ? '<div class="loading-placeholder h-full rounded-lg"></div>' : '<canvas id="hoursChart"></canvas>'}
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Detailed Sections -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
                            <!-- Top Services -->
                            <div class="modern-card rounded-2xl overflow-hidden card-hover-effect">
                                <div class="px-8 py-6 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border-b border-theme-border">
                                    <h3 class="text-xl font-bold text-theme-text-primary flex items-center">
                                        <span class="material-icons text-theme-primary mr-3">spa</span>
                                        Top Services
                                    </h3>
                                </div>
                                <div id="topServices" class="divide-y divide-theme-border min-h-[400px]">
                                    ${!dashboardData.isDataLoaded ? `
                                        <div class="flex items-center justify-center h-full p-8 text-theme-text-secondary">
                                            <div class="text-center">
                                                <div class="w-12 h-12 border-4 border-theme-primary/20 border-t-theme-primary rounded-full animate-spin mx-auto mb-4"></div>
                                                <p>Loading services...</p>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- Recent Activity -->
                            <div class="modern-card rounded-2xl overflow-hidden card-hover-effect">
                                <div class="px-8 py-6 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 border-b border-theme-border">
                                    <h3 class="text-xl font-bold text-theme-text-primary flex items-center">
                                        <span class="material-icons text-success-600 mr-3">timeline</span>
                                        Recent Activity
                                    </h3>
                                </div>
                                <div id="recentActivity" class="divide-y divide-theme-border min-h-[400px]">
                                    ${!dashboardData.isDataLoaded ? `
                                        <div class="flex items-center justify-center h-full p-8 text-theme-text-secondary">
                                            <div class="text-center">
                                                <div class="w-12 h-12 border-4 border-success-500/20 border-t-success-500 rounded-full animate-spin mx-auto mb-4"></div>
                                                <p>Loading activity...</p>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- Top Clients -->
                            <div class="modern-card rounded-2xl overflow-hidden card-hover-effect">
                                <div class="px-8 py-6 bg-gradient-to-r from-purple-50 to-violet-50 dark:from-purple-900/20 dark:to-violet-900/20 border-b border-theme-border">
                                    <h3 class="text-xl font-bold text-theme-text-primary flex items-center">
                                        <span class="material-icons text-purple-600 mr-3">stars</span>
                                        Top Clients
                                    </h3>
                                </div>
                                <div id="topClients" class="divide-y divide-theme-border min-h-[400px]">
                                    ${!dashboardData.isDataLoaded ? `
                                        <div class="flex items-center justify-center h-full p-8 text-theme-text-secondary">
                                            <div class="text-center">
                                                <div class="w-12 h-12 border-4 border-purple-500/20 border-t-purple-500 rounded-full animate-spin mx-auto mb-4"></div>
                                                <p>Loading clients...</p>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Upcoming Appointments -->
                        <div class="modern-card rounded-2xl card-hover-effect">
                            <div class="px-8 py-6 bg-gradient-to-r from-orange-50 to-yellow-50 dark:from-orange-900/20 dark:to-yellow-900/20 border-b border-theme-border">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-xl font-bold text-theme-text-primary flex items-center">
                                        <span class="material-icons text-warning-600 mr-3">event_note</span>
                                        Upcoming Appointments
                                    </h3>
                                    <span class="bg-theme-primary/10 text-theme-primary text-sm font-semibold px-4 py-2 rounded-full shadow-sm">
                                        ${dashboardData.upcomingAppointments?.length || 0} appointments
                                    </span>
                                </div>
                            </div>
                            <div id="upcomingAppointments" class="divide-y divide-theme-border">
                                ${!dashboardData.isDataLoaded ? `
                                    <div class="flex items-center justify-center h-32 p-8 text-theme-text-secondary">
                                        <div class="text-center">
                                            <div class="w-12 h-12 border-4 border-warning-500/20 border-t-warning-500 rounded-full animate-spin mx-auto mb-4"></div>
                                            <p>Loading appointments...</p>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Render individual sections only after data is loaded
            if (dashboardData.isDataLoaded) {
                renderKeyMetrics();
                renderTopServices();
                renderRecentActivity();
                renderTopClients();
                renderUpcomingAppointments();
                // Initialize global search after rendering
                setTimeout(() => {
                    initializeGlobalSearch();
                }, 100);
            }
        }

        // Updated top navigation without fake buttons
        function updateTopNavigation() {
            // Don't override the navigation if it's already properly set up
            // This function is no longer needed since we've fixed the HTML directly
            console.log('Top navigation is properly configured');
        }

        // Initialize Charts
        function initializeCharts() {
            initializeRevenueChart();
            initializeServiceChart();
            initializeStatusChart();
            initializeHoursChart();
            updateChartsTheme(); // Apply theme to newly created charts
        }

        // Enhanced Initialize Revenue Chart
        function initializeRevenueChart() {
            const ctx = document.getElementById('revenueChart');
            if (!ctx) return;
            
            const revenueData = dashboardData.analytics.revenue.byMonth;
            
            // Handle empty data case
            if (!revenueData || Object.keys(revenueData).length === 0) {
                const context = ctx.getContext('2d');
                context.clearRect(0, 0, ctx.width, ctx.height);
                context.fillStyle = '#6B7280';
                context.font = '14px Inter';
                context.textAlign = 'center';
                context.fillText('No revenue data available', ctx.width / 2, ctx.height / 2);
                return;
            }
            
            const labels = Object.keys(revenueData).sort();
            const data = labels.map(label => revenueData[label]);

            // Destroy existing chart if it exists
            if (analyticsConfig.charts.revenue) {
                analyticsConfig.charts.revenue.destroy();
            }

            // Calculate min and max values for better y-axis scaling
            const maxRevenue = Math.max(...data);
            const minRevenue = Math.min(...data);
            const yAxisMax = Math.ceil(maxRevenue * 1.1); // Add 10% padding
            const yAxisMin = Math.floor(Math.max(0, minRevenue * 0.9)); // Ensure we don't go below 0

            const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--color-primary').trim();

            analyticsConfig.charts.revenue = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels.map(label => {
                        const [year, month] = label.split('-');
                        return new Date(year, month - 1).toLocaleDateString('en-US', { 
                            month: 'short',
                            year: 'numeric'
                        });
                    }),
                    datasets: [{
                        label: 'Revenue',
                        data: data,
                        borderColor: primaryColor,
                        backgroundColor: `${primaryColor}1A`,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: primaryColor,
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1F2937',
                            bodyColor: '#1F2937',
                            borderColor: '#E5E7EB',
                            borderWidth: 1,
                            cornerRadius: 8,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return `Revenue: $${context.parsed.y.toLocaleString('en-US', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    })}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            border: {
                                display: false
                            },
                            ticks: {
                                color: '#6B7280',
                                font: {
                                    family: 'Inter',
                                    size: 12
                                },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            min: yAxisMin,
                            max: yAxisMax,
                            grid: {
                                color: '#F3F4F6',
                                drawBorder: false
                            },
                            border: {
                                display: false
                            },
                            ticks: {
                                color: '#6B7280',
                                font: {
                                    family: 'Inter',
                                    size: 12
                                },
                                padding: 8,
                                callback: function(value) {
                                    return '$' + value.toLocaleString('en-US', {
                                        minimumFractionDigits: 0,
                                        maximumFractionDigits: 0
                                    });
                                }
                            }
                        }
                    }
                }
            });
        }

        // Enhanced Initialize Service Chart
        function initializeServiceChart() {
            const ctx = document.getElementById('serviceChart');
            if (!ctx) return;
            
            const serviceData = dashboardData.analytics.services.popular.slice(0, 5);
            
            if (!serviceData || serviceData.length === 0) {
                const context = ctx.getContext('2d');
                context.clearRect(0, 0, ctx.width, ctx.height);
                context.fillStyle = '#9CA3AF';
                context.font = '16px Inter';
                context.textAlign = 'center';
                context.fillText('No service data available', ctx.width / 2, ctx.height / 2);
                return;
            }

            // Destroy existing chart if it exists
            if (analyticsConfig.charts.service) {
                analyticsConfig.charts.service.destroy();
            }

            const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--color-primary').trim();
            
            analyticsConfig.charts.service = new Chart(ctx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: serviceData.map(s => s.name),
                    datasets: [{
                        data: serviceData.map(s => s.totalBookings),
                        backgroundColor: [
                            primaryColor,
                            analyticsConfig.colors.success,
                            analyticsConfig.colors.warning,
                            analyticsConfig.colors.purple,
                            analyticsConfig.colors.teal
                        ],
                        borderWidth: 4,
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-primary').trim(),
                        hoverBorderWidth: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                font: {
                                    family: 'Inter',
                                    size: 12,
                                    weight: '500'
                                },
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim()
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#374151',
                            bodyColor: '#374151',
                            borderColor: '#E5E7EB',
                            borderWidth: 1,
                            cornerRadius: 12,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed * 100) / total).toFixed(1);
                                    return context.label + ': ' + context.parsed + ' bookings (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Enhanced Initialize Status Chart
        function initializeStatusChart() {
            const ctx = document.getElementById('statusChart');
            if (!ctx) return;
            
            const statusData = dashboardData.analytics.appointments.statusDistribution;

            // Destroy existing chart if it exists
            if (analyticsConfig.charts.status) {
                analyticsConfig.charts.status.destroy();
            }
            
            analyticsConfig.charts.status = new Chart(ctx.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: ['Completed', 'Upcoming', 'Canceled'],
                    datasets: [{
                        data: [statusData.completed, statusData.upcoming, statusData.canceled],
                        backgroundColor: [
                            analyticsConfig.colors.success,
                            getComputedStyle(document.documentElement).getPropertyValue('--color-primary').trim(),
                            analyticsConfig.colors.danger
                        ],
                        borderWidth: 4,
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-primary').trim(),
                        hoverBorderWidth: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                font: {
                                    family: 'Inter',
                                    size: 12,
                                    weight: '500'
                                },
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim()
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#374151',
                            bodyColor: '#374151',
                            borderColor: '#E5E7EB',
                            borderWidth: 1,
                            cornerRadius: 12,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed * 100) / total).toFixed(1);
                                    return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Enhanced Initialize Hours Chart
        function initializeHoursChart() {
            const ctx = document.getElementById('hoursChart');
            if (!ctx) return;
            
            const hourlyData = dashboardData.analytics.appointments.hourlyDistribution;

            // Destroy existing chart if it exists
            if (analyticsConfig.charts.hours) {
                analyticsConfig.charts.hours.destroy();
            }

            const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--color-primary').trim();
            
            analyticsConfig.charts.hours = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => {
                        const hour = i === 0 ? 12 : i > 12 ? i - 12 : i;
                        const ampm = i < 12 ? 'AM' : 'PM';
                        return `${hour}${ampm}`;
                    }),
                    datasets: [{
                        label: 'Appointments',
                        data: hourlyData,
                        backgroundColor: `${primaryColor}80`,
                        borderColor: primaryColor,
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#374151',
                            bodyColor: '#374151',
                            borderColor: '#E5E7EB',
                            borderWidth: 1,
                            cornerRadius: 12,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return 'Appointments: ' + context.parsed.y;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            border: {
                                display: false
                            },
                            ticks: {
                                color: '#6B7280',
                                font: {
                                    family: 'Inter',
                                    size: 10
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#F3F4F6',
                                borderDash: [5, 5]
                            },
                            border: {
                                display: false
                            },
                            ticks: {
                                stepSize: 1,
                                color: '#6B7280',
                                font: {
                                    family: 'Inter',
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        // Utility Functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        function formatRelativeTime(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            return `${Math.floor(diffInSeconds / 86400)}d ago`;
        }

        // Enhanced Loading and Error States
        function showLoadingState() {
            const mainContent = document.querySelector('main');
            if (mainContent) {
                mainContent.innerHTML = `
                    <div class="flex items-center justify-center min-h-[60vh]">
                        <div class="text-center">
                            <div class="relative mb-8">
                                <div class="w-16 h-16 border-4 border-theme-primary border-t-transparent rounded-full animate-spin mx-auto"></div>
                            </div>
                            <h3 class="text-xl font-semibold text-theme-text-primary mb-2">Loading Dashboard</h3>
                            <p class="text-theme-text-secondary">Please wait while we fetch your data...</p>
                        </div>
                    </div>
                `;
            }
        }

        function showErrorState() {
            const mainContent = document.querySelector('main');
            if (mainContent) {
                mainContent.innerHTML = `
                    <div class="text-center py-16">
                        <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-red-100 to-rose-100 dark:from-red-900/20 dark:to-rose-900/20 rounded-3xl flex items-center justify-center">
                            <span class="material-icons text-red-500 text-4xl">error_outline</span>
                        </div>
                        <h3 class="text-2xl font-bold text-theme-text-primary mb-3">Unable to load dashboard</h3>
                        <p class="text-theme-text-secondary text-lg mb-6">There was an error loading your analytics data.</p>
                        <button onclick="location.reload()" class="btn-modern inline-flex items-center">
                            <span class="material-icons text-sm mr-2">refresh</span>
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        // Enhanced Refresh Dashboard
        async function refreshDashboard() {
            try {
                showLoadingState();
                
                // Clear localStorage to force fresh data fetch
                localStorage.removeItem('appointmentTypes');
                localStorage.removeItem('upcomingAppointments');
                localStorage.removeItem('pastAppointments');
                localStorage.removeItem('userData');
                localStorage.removeItem('services');
                
                // Reset data loaded flag
                dashboardData.isDataLoaded = false;
                
                await fetchAllData();
                await loadAndProcessData();
                dashboardData.isDataLoaded = true;
                renderDashboard();
                
                // Destroy existing charts before recreating
                Object.values(analyticsConfig.charts).forEach(chart => {
                    if (chart && typeof chart.destroy === 'function') {
                        chart.destroy();
                    }
                });
                analyticsConfig.charts = {};
                
                setTimeout(() => {
                    initializeCharts();
                    document.querySelectorAll('.loading-placeholder').forEach(el => {
                        el.classList.add('hidden');
                    });
                }, 500);
                
                // Show success message
                showToast('Dashboard refreshed successfully!', 'success');
            } catch (error) {
                console.error("Error refreshing dashboard:", error);
                showErrorState();
                showToast('Error refreshing dashboard. Please try again.', 'error');
            }
        }

        // Toast Notification Function
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-emerald-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-4 rounded-xl shadow-lg z-50 transform translate-x-full transition-transform duration-300`;
            toast.innerHTML = `
                <div class="flex items-center space-x-3">
                    <span class="material-icons text-sm">${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info'}</span>
                    <span class="font-medium">${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // API Fetch Functions (keeping existing ones)
        function fetchAndStoreAppointmentTypes() {
            const requestData = {
                crmAPIRequest: { 
                    type: 1 // Type 1 for appointment types
                }
            };
            
            return ZOHO.CRM.FUNCTIONS.execute("acuityscheduling1__apihandler", requestData)
                .then(function(data) {
                    try {
                        console.log("Raw response from Zoho function for appointment types:", data);
                        
                        if (data.code === "INVALID_DATA" || data.code === "ERROR") {
                            throw new Error(data.message || "Error from Zoho function");
                        }
                        
                        if (!data.details || !data.details.output) {
                            throw new Error("Invalid response structure from Zoho function");
                        }
                        
                        const outputData = JSON.parse(data.details.output);
                        
                        if (outputData.status_code !== 200) {
                            throw new Error(`API returned status code ${outputData.status_code}`);
                        }
                        
                        if (!outputData.response) {
                            throw new Error("No response data found");
                        }
                        
                        const appointmentTypes = JSON.parse(outputData.response);
                        localStorage.setItem('appointmentTypes', JSON.stringify(appointmentTypes));
                        console.log("Appointment types stored successfully", appointmentTypes);
                        
                        return appointmentTypes;
                    } catch (error) {
                        console.error("Error processing appointment types:", error);
                        throw error;
                    }
                })
                .catch(function(error) {
                    console.error("Error fetching appointment types:", error);
                    throw error;
                });
        }
        
        function fetchAndStoreAppointments() {
            const requestData = {
                crmAPIRequest: { 
                    type: 2 // Type 2 for appointments
                }
            };
            
            return ZOHO.CRM.FUNCTIONS.execute("acuityscheduling1__apihandler", requestData)
                .then(function(data) {
                    try {
                        console.log("Raw response from Zoho function for appointments:", data);
                        
                        if (data.code === "INVALID_DATA" || data.code === "ERROR") {
                            throw new Error(data.message || "Error from Zoho function");
                        }
                        
                        if (!data.details || !data.details.output) {
                            throw new Error("Invalid response structure from Zoho function");
                        }
                        
                        const outputData = JSON.parse(data.details.output);
                        
                        if (outputData.status_code !== 200) {
                            throw new Error(`API returned status code ${outputData.status_code}`);
                        }
                        
                        if (!outputData.response) {
                            throw new Error("No response data found");
                        }
                        
                        const appointments = JSON.parse(outputData.response);
                        
                        // Separate past and upcoming appointments
                        const now = new Date();
                        const pastAppointments = [];
                        const upcomingAppointments = [];
                        
                        appointments.forEach(appointment => {
                            const appointmentDate = new Date(appointment.datetime);
                            if (appointmentDate < now) {
                                pastAppointments.push(appointment);
                            } else {
                                upcomingAppointments.push(appointment);
                            }
                        });
                        
                        // Store in localStorage
                        localStorage.setItem('pastAppointments', JSON.stringify(pastAppointments));
                        localStorage.setItem('upcomingAppointments', JSON.stringify(upcomingAppointments));
                        console.log("Appointments stored successfully", { past: pastAppointments, upcoming: upcomingAppointments });
                        
                        return { pastAppointments, upcomingAppointments };
                    } catch (error) {
                        console.error("Error processing appointments:", error);
                        throw error;
                    }
                })
                .catch(function(error) {
                    console.error("Error fetching appointments:", error);
                    throw error;
                });
        }
        
        function fetchAndStoreUserData() {
            const requestData = {
                crmAPIRequest: { 
                    type: 3 // Type 3 for GetMe
                }
            };
            
            return ZOHO.CRM.FUNCTIONS.execute("acuityscheduling1__apihandler", requestData)
                .then(function(data) {
                    try {
                        console.log("Raw response from Zoho function for user data:", data);
                        
                        if (data.code === "INVALID_DATA" || data.code === "ERROR") {
                            throw new Error(data.message || "Error from Zoho function");
                        }
                        
                        if (!data.details || !data.details.output) {
                            throw new Error("Invalid response structure from Zoho function");
                        }
                        
                        const outputData = JSON.parse(data.details.output);
                        
                        if (outputData.status_code !== 200) {
                            throw new Error(`API returned status code ${outputData.status_code}`);
                        }
                        
                        if (!outputData.response) {
                            throw new Error("No response data found");
                        }
                        
                        const userData = JSON.parse(outputData.response);
                        localStorage.setItem('userData', JSON.stringify(userData));
                        console.log("User data stored successfully", userData);
                        
                        return userData;
                    } catch (error) {
                        console.error("Error processing user data:", error);
                        throw error;
                    }
                })
                .catch(function(error) {
                    console.error("Error fetching user data:", error);
                    throw error;
                });
        }

        // Export Functions
        function exportDashboardReport() {
            const reportData = {
                generatedOn: new Date().toISOString(),
                businessName: dashboardData.userData.name,
                period: 'All Time',
                overview: dashboardData.analytics.overview,
                topServices: dashboardData.analytics.services.popular.slice(0, 10),
                topClients: dashboardData.analytics.clients.topClients.slice(0, 10),
                revenueAnalytics: dashboardData.analytics.revenue
            };

            const dataStr = JSON.stringify(reportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `dashboard-report-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('Report exported successfully!', 'success');
        }

        // Quick Action Functions
        function viewAllAppointmentTypes() {
            window.location.href = 'appointment_types.html';
        }

        function viewAllUpcoming() {
            window.location.href = 'appointments.html?type=upcoming';
        }

        function viewAllPast() {
            window.location.href = 'appointments.html?type=past';
        }

        // Enhanced View More Functions
        function showAllServices() {
            const modal = createEnhancedDataModal('All Services', renderAllServicesTable());
            document.body.appendChild(modal);
        }

        function showAllClients() {
            const modal = createEnhancedDataModal('All Clients', renderAllClientsTable());
            document.body.appendChild(modal);
        }

        function showAllActivity() {
            const modal = createEnhancedDataModal('All Activity', renderAllActivityTable());
            document.body.appendChild(modal);
        }

        // Enhanced Create Data Modal
        function createEnhancedDataModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 animate-fade-in';
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };

            modal.innerHTML = `
                <div class="bg-theme-bg-primary rounded-3xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden animate-slide-in">
                    <div class="p-8 border-b border-theme-border bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20">
                        <div class="flex items-center justify-between">
                            <h2 class="text-3xl font-bold text-theme-text-primary">${title}</h2>
                            <button onclick="this.closest('.fixed').remove()" class="p-3 rounded-full text-theme-text-secondary hover:text-theme-text-primary hover:bg-theme-bg-accent transition-all duration-200 transform hover:scale-110">
                                <span class="material-icons text-xl">close</span>
                            </button>
                        </div>
                    </div>
                    <div class="overflow-y-auto max-h-[calc(90vh-140px)]">
                        ${content}
                    </div>
                </div>
            `;

            return modal;
        }

        // Enhanced Render All Services Table
        function renderAllServicesTable() {
            const services = dashboardData.analytics.services.all.sort((a, b) => b.revenue - a.revenue);
            
            return `
                <div class="p-8">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-theme-border">
                            <thead class="bg-theme-bg-accent">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-theme-text-secondary uppercase tracking-wider">Service</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-theme-text-secondary uppercase tracking-wider">Category</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-theme-text-secondary uppercase tracking-wider">Bookings</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-theme-text-secondary uppercase tracking-wider">Revenue</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-theme-text-secondary uppercase tracking-wider">Avg Revenue</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-theme-text-secondary uppercase tracking-wider">Duration</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-theme-text-secondary uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody class="bg-theme-bg-primary divide-y divide-theme-border">
                                ${services.map((service, index) => `
                                    <tr class="hover:bg-theme-bg-accent transition-all duration-200">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div class="w-12 h-12 rounded-xl flex items-center justify-center mr-4 shadow-lg" style="background-color: ${service.color}20">
                                                    <span class="material-icons text-lg" style="color: ${service.color}">spa</span>
                                                </div>
                                                <div class="text-sm font-semibold text-theme-text-primary">${service.name}</div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-theme-text-secondary font-medium">${service.category}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-theme-text-primary">${service.totalBookings}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-emerald-600">$${service.revenue.toFixed(2)}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-theme-text-primary font-medium">$${(service.averageRevenue || 0).toFixed(2)}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-theme-text-secondary">${service.duration} min</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${service.active ? 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/20 dark:text-emerald-300' : 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-300'}">
                                                ${service.active ? 'Active' : 'Inactive'}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Enhanced Render All Clients Table - Fixed to show all clients
        function renderAllClientsTable() {
            const clients = dashboardData.analytics.clients.allClients; // Use allClients instead of topClients
            
            return `
                <div class="p-8">
                    <div class="mb-4 text-sm text-theme-text-secondary">
                        Showing all ${clients.length} clients sorted by total spending
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-theme-border">
                            <thead class="bg-theme-bg-accent">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-theme-text-secondary uppercase tracking-wider">Client</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-theme-text-secondary uppercase tracking-wider">Contact</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-theme-text-secondary uppercase tracking-wider">Appointments</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-theme-text-secondary uppercase tracking-wider">Total Spent</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-theme-text-secondary uppercase tracking-wider">Avg Spend</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-theme-text-secondary uppercase tracking-wider">Last Visit</th>
                                </tr>
                            </thead>
                            <tbody class="bg-theme-bg-primary divide-y divide-theme-border">
                                ${clients.map((client, index) => {
                                    const isVIP = client.totalSpent > 500;
                                    const lastVisit = client.lastVisit ? new Date(client.lastVisit).toLocaleDateString() : 'Never';
                                    
                                    return `
                                        <tr class="hover:bg-theme-bg-accent transition-all duration-200">
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="flex items-center">
                                                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-theme-primary/20 to-theme-primary/40 flex items-center justify-center text-theme-primary font-bold text-sm mr-4 shadow-lg">
                                                        ${client.name.split(' ').map(n => n[0]).join('').toUpperCase()}
                                                    </div>
                                                    <div>
                                                        <div class="flex items-center space-x-2">
                                                            <div class="text-sm font-semibold text-theme-text-primary">${client.name}</div>
                                                            ${isVIP ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-300">VIP</span>' : ''}
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-sm text-theme-text-primary font-medium">${client.email || 'N/A'}</div>
                                                <div class="text-sm text-theme-text-secondary">${client.phone || 'N/A'}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-theme-text-primary">${client.appointments.length}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-emerald-600">$${client.totalSpent.toFixed(2)}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-theme-text-primary font-medium">$${(client.totalSpent / client.appointments.length).toFixed(2)}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-theme-text-secondary">${lastVisit}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Enhanced Render All Activity Table
        function renderAllActivityTable() {
            const allActivity = [...dashboardData.pastAppointments, ...dashboardData.upcomingAppointments]
                .sort((a, b) => new Date(b.datetimeCreated) - new Date(a.datetimeCreated));
            
            return `
                <div class="p-8">
                    <div class="mb-4 text-sm text-theme-text-secondary">
                        Showing all ${allActivity.length} activities sorted by creation date
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-theme-border">
                            <thead class="bg-theme-bg-accent">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-theme-text-secondary uppercase tracking-wider">Client</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-theme-text-secondary uppercase tracking-wider">Service</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-theme-text-secondary uppercase tracking-wider">Date & Time</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-theme-text-secondary uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-theme-text-secondary uppercase tracking-wider">Price</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-theme-text-secondary uppercase tracking-wider">Created</th>
                                </tr>
                            </thead>
                            <tbody class="bg-theme-bg-primary divide-y divide-theme-border">
                                ${allActivity.map((apt, index) => {
                                    const isPast = new Date(apt.datetime) < new Date();
                                    const status = apt.canceled ? 'Cancelled' : (isPast ? 'Completed' : 'Scheduled');
                                    const statusColor = apt.canceled ? 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-300' : (isPast ? 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/20 dark:text-emerald-300' : 'bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-300');
                                    const service = dashboardData.services.find(s => s.id === apt.appointmentTypeID);
                                    const price = apt.priceSold || apt.price || (service ? service.price : 0);
                                    
                                    return `
                                        <tr class="hover:bg-theme-bg-accent transition-all duration-200">
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-sm font-semibold text-theme-text-primary">${apt.firstName} ${apt.lastName}</div>
                                                <div class="text-sm text-theme-text-secondary">${apt.phone || apt.email || 'N/A'}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-theme-text-primary font-medium">${apt.type}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-sm text-theme-text-primary font-medium">${new Date(apt.datetime).toLocaleDateString()}</div>
                                                <div class="text-sm text-theme-text-secondary">${apt.time} - ${apt.endTime}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${statusColor}">
                                                    ${status}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-theme-text-primary">$${parseFloat(price).toFixed(2)}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-theme-text-secondary">${formatRelativeTime(new Date(apt.datetimeCreated))}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Mobile responsive enhancements
        function adjustMobileLayout() {
            const isMobile = window.innerWidth < 1024;
            
            if (isMobile) {
                // Adjust chart containers for mobile
                document.querySelectorAll('.chart-container').forEach(container => {
                    container.style.height = '280px';
                });
                
                // Adjust grid layouts for mobile
                const keyMetrics = document.getElementById('keyMetrics');
                if (keyMetrics) {
                    keyMetrics.className = 'grid grid-cols-1 sm:grid-cols-2 gap-4';
                }
            }
        }

        // Chart period change handler
        document.addEventListener('change', function(e) {
            if (e.target.id === 'revenueChartPeriod') {
                updateRevenueChart(e.target.value);
            }
        });

        function updateRevenueChart(period) {
            const revenueData = dashboardData.analytics.revenue.byMonth;
            let filteredData = {};
            
            const now = new Date();
            let cutoffDate;
            
            if (period === '6months') {
                cutoffDate = new Date(now.getFullYear(), now.getMonth() - 6, 1);
            } else if (period === '12months') {
                cutoffDate = new Date(now.getFullYear(), now.getMonth() - 12, 1);
            }
            
            if (cutoffDate) {
                const cutoffKey = `${cutoffDate.getFullYear()}-${String(cutoffDate.getMonth() + 1).padStart(2, '0')}`;
                Object.keys(revenueData)
                    .filter(key => key >= cutoffKey)
                    .sort()
                    .forEach(key => {
                        filteredData[key] = revenueData[key];
                    });
            } else {
                filteredData = { ...revenueData };
            }
            
            // Store current data temporarily
            const originalData = dashboardData.analytics.revenue.byMonth;
            dashboardData.analytics.revenue.byMonth = filteredData;
            
            // Reinitialize chart
            initializeRevenueChart();
            
            // Restore original data
            dashboardData.analytics.revenue.byMonth = originalData;
        }

        // Event Listeners
        window.addEventListener('resize', adjustMobileLayout);
        window.addEventListener('load', adjustMobileLayout);

        // Modal Functions
        function openNewAppointmentModal() {
            const modal = document.getElementById('newAppointmentModal');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            populateServiceOptions();
            
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('appointmentDate').min = today;
        }

        function closeNewAppointmentModal() {
            const modal = document.getElementById('newAppointmentModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            document.getElementById('newAppointmentForm').reset();
            document.getElementById('serviceDetails').classList.add('hidden');
        }

        function populateServiceOptions() {
            const serviceSelect = document.getElementById('serviceSelect');
            serviceSelect.innerHTML = '<option value="">Choose a service...</option>';
            
            dashboardData.services.forEach(service => {
                if (service.active) {
                    const option = document.createElement('option');
                    option.value = service.id;
                    option.textContent = `${service.name} - $${service.price} (${service.duration} min)`;
                    serviceSelect.appendChild(option);
                }
            });
        }

        // Update service details display
        function updateServiceDetails(service) {
            const serviceDetails = document.getElementById('serviceDetails');
            if (service) {
                serviceDetails.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="text-sm font-semibold text-theme-text-primary">${service.name}</h4>
                            <p class="text-sm text-theme-text-secondary">${service.category || 'General'}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-semibold text-theme-primary">$${service.price}</p>
                            <p class="text-sm text-theme-text-secondary">${service.duration} minutes</p>
                        </div>
                    </div>
                `;
                serviceDetails.classList.remove('hidden');
            } else {
                serviceDetails.classList.add('hidden');
            }
        }

        // Service selection handler
        document.addEventListener('change', function(e) {
            if (e.target.id === 'serviceSelect') {
                const serviceId = e.target.value;
                const serviceDetails = document.getElementById('serviceDetails');
                
                if (serviceId) {
                    const service = dashboardData.services.find(s => s.id === serviceId);
                    if (service) {
                        updateServiceDetails(service);
                    }
                } else {
                    serviceDetails.classList.add('hidden');
                }
            }
        });

        // Form submission handler
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('newAppointmentForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = {
                        firstName: document.getElementById('firstName').value,
                        lastName: document.getElementById('lastName').value,
                        email: document.getElementById('email').value,
                        phone: document.getElementById('phone').value,
                        serviceId: document.getElementById('serviceSelect').value,
                        date: document.getElementById('appointmentDate').value,
                        time: document.getElementById('appointmentTime').value,
                        notes: document.getElementById('notes').value
                    };
                    
                    console.log('New appointment data:', formData);
                    
                    // Here you would typically send the data to your backend
                    // For now, we'll just show a success message
                    showToast('Appointment scheduled successfully! (This is a demo)', 'success');
                    closeNewAppointmentModal();
                });
            }
        });

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('newAppointmentModal');
            if (modal && e.target === modal) {
                closeNewAppointmentModal();
            }
        });

        // Fixed Anonymous Scheduling Modal - Using actual user data
        function openAnonymousScheduling() {
            const modal = document.getElementById('anonymousSchedulingModal');
            const frame = document.getElementById('schedulingFrame');
            const loader = document.getElementById('schedulingLoader');
            
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Reset states
            frame.style.display = 'none';
            loader.style.display = 'flex';
            
            // Use the actual scheduling URL from user data
            const schedulingUrl = dashboardData.userData.schedulingPage || 'https://app.acuityscheduling.com/schedule.php?owner=35757288';
            
            loader.innerHTML = `
                <div class="text-center">
                    <div class="w-16 h-16 border-4 border-theme-primary border-t-transparent rounded-full animate-spin mb-4 mx-auto"></div>
                    <p class="text-theme-text-primary font-medium">Loading scheduling page...</p>
                </div>
            `;
            
            frame.src = schedulingUrl;
            frame.onload = function() {
                loader.style.display = 'none';
                frame.style.display = 'block';
            };
            
            frame.onerror = function() {
                loader.innerHTML = `
                    <div class="text-center">
                        <div class="w-16 h-16 mx-auto mb-4">
                            <span class="material-icons text-red-500 text-5xl">error_outline</span>
                        </div>
                        <p class="text-theme-text-primary font-medium mb-4">Failed to load scheduling page</p>
                        <button onclick="retrySchedulingLoad()" class="px-4 py-2 bg-theme-primary text-white rounded-lg hover:bg-theme-accent">
                            Retry
                        </button>
                    </div>
                `;
            };
        }

        function closeAnonymousScheduling() {
            const modal = document.getElementById('anonymousSchedulingModal');
            const frame = document.getElementById('schedulingFrame');
            const loader = document.getElementById('schedulingLoader');
            
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            frame.src = '';
            frame.style.display = 'none';
            loader.style.display = 'flex';
        }

        function retrySchedulingLoad() {
            closeAnonymousScheduling();
            setTimeout(() => openAnonymousScheduling(), 100);
        }

        // ADDED Global Search Functionality
        let searchData = {
            appointments: [],
            services: [],
            clients: []
        };

        function initializeGlobalSearch() {
            // Prepare search data
            searchData.appointments = [...dashboardData.pastAppointments, ...dashboardData.upcomingAppointments];
            searchData.services = dashboardData.services;
            
            // Extract unique clients
            const clientsMap = new Map();
            searchData.appointments.forEach(apt => {
                const clientKey = `${apt.firstName} ${apt.lastName}`.trim();
                if (!clientsMap.has(clientKey)) {
                    clientsMap.set(clientKey, {
                        name: clientKey,
                        phone: apt.phone,
                        email: apt.email,
                        appointments: []
                    });
                }
                clientsMap.get(clientKey).appointments.push(apt);
            });
            searchData.clients = Array.from(clientsMap.values());

            // Add search event listener
            const searchInput = document.querySelector('input[placeholder*="Search"]');
            if (searchInput) {
                searchInput.addEventListener('input', handleGlobalSearch);
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleGlobalSearch(e);
                    }
                });
            }
        }

        function handleGlobalSearch(event) {
            const query = event.target.value.toLowerCase().trim();
            
            if (query.length < 2) {
                hideSearchResults();
                return;
            }

            const results = {
                appointments: [],
                services: [],
                clients: []
            };

            // Search appointments
            results.appointments = searchData.appointments.filter(apt => 
                `${apt.firstName} ${apt.lastName}`.toLowerCase().includes(query) ||
                apt.type.toLowerCase().includes(query) ||
                (apt.phone && apt.phone.includes(query)) ||
                (apt.email && apt.email.toLowerCase().includes(query))
            ).slice(0, 5);

            // Search services
            results.services = searchData.services.filter(service =>
                service.name.toLowerCase().includes(query) ||
                service.category.toLowerCase().includes(query)
            ).slice(0, 5);

            // Search clients
            results.clients = searchData.clients.filter(client =>
                client.name.toLowerCase().includes(query) ||
                (client.phone && client.phone.includes(query)) ||
                (client.email && client.email.toLowerCase().includes(query))
            ).slice(0, 5);

            showSearchResults(results, query);
        }

        function showSearchResults(results, query) {
            let existingResults = document.getElementById('search-results');
            if (existingResults) {
                existingResults.remove();
            }

            const searchContainer = document.querySelector('input[placeholder*="Search"]').closest('.relative');
            const resultsContainer = document.createElement('div');
            resultsContainer.id = 'search-results';
            resultsContainer.className = 'absolute top-full left-0 right-0 mt-2 bg-theme-bg-primary border border-theme-border rounded-lg shadow-2xl z-50 max-h-96 overflow-y-auto hide-scrollbar';

            const totalResults = results.appointments.length + results.services.length + results.clients.length;
            
            if (totalResults === 0) {
                resultsContainer.innerHTML = `
                    <div class="p-4 text-center text-theme-text-secondary">
                        <span class="material-icons text-2xl mb-2 opacity-50">search_off</span>
                        <p>No results found for "${query}"</p>
                    </div>
                `;
            } else {
                let html = `<div class="p-2 border-b border-theme-border bg-theme-bg-accent">
                    <p class="text-xs font-semibold text-theme-text-secondary uppercase">Found ${totalResults} results</p>
                </div>`;

                // Appointments section with click handlers
                if (results.appointments.length > 0) {
                    html += `<div class="p-2"><h4 class="text-sm font-semibold text-theme-text-primary mb-2 flex items-center">
                        <span class="material-icons text-sm mr-2">event</span>Appointments
                    </h4>`;
                    
                    results.appointments.forEach(apt => {
                        const isPast = new Date(apt.datetime) < new Date();
                        const statusColor = apt.canceled ? 'text-red-500' : (isPast ? 'text-emerald-500' : 'text-blue-500');
                        html += `
                            <div class="p-2 rounded-lg hover:bg-theme-bg-accent cursor-pointer border-l-2 border-${statusColor.split('-')[1]}-400 mb-1" onclick="showAppointmentDetails('${apt.id}')">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-medium text-theme-text-primary text-sm">${apt.firstName} ${apt.lastName}</p>
                                        <p class="text-xs text-theme-text-secondary">${apt.type}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-xs ${statusColor} font-medium">${new Date(apt.datetime).toLocaleDateString()}</p>
                                        <p class="text-xs text-theme-text-secondary">${apt.time}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                // Services section with click handlers
                if (results.services.length > 0) {
                    html += `<div class="p-2 border-t border-theme-border"><h4 class="text-sm font-semibold text-theme-text-primary mb-2 flex items-center">
                        <span class="material-icons text-sm mr-2">spa</span>Services
                    </h4>`;
                    
                    results.services.forEach(service => {
                        html += `
                            <div class="p-2 rounded-lg hover:bg-theme-bg-accent cursor-pointer mb-1" onclick="showServiceDetails('${service.id}')">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 rounded-lg mr-3 flex items-center justify-center" style="background-color: ${service.color}20">
                                            <span class="material-icons text-sm" style="color: ${service.color}">spa</span>
                                        </div>
                                        <div>
                                            <p class="font-medium text-theme-text-primary text-sm">${service.name}</p>
                                            <p class="text-xs text-theme-text-secondary">${service.duration} min  ${service.category}</p>
                                        </div>
                                    </div>
                                    <p class="text-sm font-semibold text-theme-text-primary">$${service.price}</p>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                // Clients section with click handlers
                if (results.clients.length > 0) {
                    html += `<div class="p-2 border-t border-theme-border"><h4 class="text-sm font-semibold text-theme-text-primary mb-2 flex items-center">
                        <span class="material-icons text-sm mr-2">person</span>Clients
                    </h4>`;
                    
                    results.clients.forEach(client => {
                        const initials = client.name.split(' ').map(n => n[0]).join('').toUpperCase();
                        html += `
                            <div class="p-2 rounded-lg hover:bg-theme-bg-accent cursor-pointer mb-1" onclick="showClientDetails('${client.name}')">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 rounded-full bg-theme-primary/20 text-theme-primary text-xs font-bold flex items-center justify-center mr-3">
                                        ${initials}
                                    </div>
                                    <div>
                                        <p class="font-medium text-theme-text-primary text-sm">${client.name}</p>
                                        <p class="text-xs text-theme-text-secondary">${client.appointments.length} appointments</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                resultsContainer.innerHTML = html;
            }

            searchContainer.appendChild(resultsContainer);

            // Hide results when clicking outside
            document.addEventListener('click', function hideOnClickOutside(e) {
                if (!searchContainer.contains(e.target)) {
                    hideSearchResults();
                    document.removeEventListener('click', hideOnClickOutside);
                }
            });
        }

        function hideSearchResults() {
            const existingResults = document.getElementById('search-results');
            if (existingResults) {
                existingResults.remove();
            }
        }

        // Add these missing render functions after the renderDashboard function

        // Enhanced Render Key Metrics
        function renderKeyMetrics() {
            const container = document.getElementById('keyMetrics');
            if (!container || !dashboardData.analytics) return;
            
            const metrics = dashboardData.analytics.overview;

            const metricCards = [
                {
                    title: 'Total Revenue',
                    value: `$${metrics.totalRevenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`,
                    icon: 'trending_up',
                    gradient: 'from-emerald-500 to-teal-600',
                    subtitle: `$${metrics.monthlyRevenue.toFixed(2)} this month`,
                    change: '+12.5%'
                },
                {
                    title: 'Total Appointments',
                    value: metrics.totalAppointments.toLocaleString(),
                    icon: 'event_available',
                    gradient: 'from-blue-500 to-cyan-600',
                    subtitle: `${metrics.todayAppointments} scheduled today`,
                    change: '+8.2%'
                },
                {
                    title: 'Active Services',
                    value: `${metrics.activeServices}/${metrics.totalServices}`,
                    icon: 'spa',
                    gradient: 'from-purple-500 to-pink-600',
                    subtitle: 'services available',
                    change: 'Active'
                },
                {
                    title: 'Success Rate',
                    value: `${(100 - metrics.cancellationRate).toFixed(1)}%`,
                    icon: 'check_circle',
                    gradient: metrics.cancellationRate > 15 ? 'from-red-500 to-rose-600' : 'from-green-500 to-emerald-600',
                    subtitle: `${metrics.canceledAppointments} cancelled`,
                    change: metrics.cancellationRate > 15 ? 'Needs attention' : 'Excellent'
                }
            ];

            container.innerHTML = metricCards.map((metric, index) => `
                <div class="relative overflow-hidden rounded-2xl bg-gradient-to-br ${metric.gradient} text-white shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 animate-fade-in" style="animation-delay: ${index * 0.1}s">
                    <div class="absolute inset-0 bg-black bg-opacity-10"></div>
                    <div class="relative p-8">
                        <div class="flex items-center justify-between mb-6">
                            <div class="p-3 bg-white bg-opacity-20 rounded-xl backdrop-blur-sm">
                                <span class="material-icons text-2xl text-white">${metric.icon}</span>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-medium text-white text-opacity-80 px-3 py-1 bg-white bg-opacity-20 rounded-full">
                                    ${metric.change}
                                </span>
                            </div>
                        </div>
                        <div>
                            <p class="text-white text-opacity-90 text-sm font-medium mb-2">${metric.title}</p>
                            <p class="text-3xl font-bold text-white mb-2">${metric.value}</p>
                            <p class="text-white text-opacity-70 text-sm">${metric.subtitle}</p>
                        </div>
                    </div>
                    <div class="absolute bottom-0 left-0 right-0 h-1 bg-white bg-opacity-30"></div>
                </div>
            `).join('');
        }

        // Enhanced Render Top Services
        function renderTopServices() {
            const container = document.getElementById('topServices');
            if (!container || !dashboardData.analytics) return;
            
            const services = dashboardData.analytics.services.popular.slice(0, 5);
            const allServices = dashboardData.analytics.services.all;

            if (!services.length) {
                container.innerHTML = `
                    <div class="p-8 text-center">
                        <div class="w-16 h-16 mx-auto mb-4 bg-blue-100 dark:bg-blue-900/20 rounded-2xl flex items-center justify-center">
                            <span class="material-icons text-blue-500 text-2xl">spa</span>
                        </div>
                        <p class="text-theme-text-secondary">No services data available</p>
                    </div>
                `;
                return;
            }

            const servicesHtml = services.map((service, index) => `
                <div class="p-6 hover:bg-theme-bg-accent transition-all duration-300 group animate-slide-in" style="animation-delay: ${index * 0.1}s">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="flex-shrink-0">
                                <div class="w-14 h-14 rounded-2xl flex items-center justify-center shadow-lg group-hover:shadow-xl transition-all duration-300 transform group-hover:scale-110" 
                                     style="background: linear-gradient(135deg, ${service.color}20, ${service.color}40)">
                                    <span class="material-icons text-xl" style="color: ${service.color}">spa</span>
                                </div>
                            </div>
                            <div>
                                <p class="text-base font-bold text-theme-text-primary mb-2">${service.name}</p>
                                <div class="flex items-center space-x-3">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-300">
                                        ${service.bookingCount} bookings
                                    </span>
                                    <span class="text-xs text-theme-text-secondary">${service.duration} min</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-xl font-bold text-theme-text-primary">$${service.revenue.toFixed(2)}</p>
                            <p class="text-sm text-emerald-600 font-semibold">$${((service.revenue / service.bookingCount) || 0).toFixed(0)} avg</p>
                        </div>
                    </div>
                </div>
            `).join('');

            const viewMoreButton = allServices.length > 5 ? `
                <div class="p-6 bg-theme-bg-accent">
                    <button onclick="showAllServices()" class="btn-view-more w-full text-center py-3 px-6 text-sm font-semibold flex items-center justify-center space-x-2">
                        <span>View All ${allServices.length} Services</span>
                        <span class="material-icons text-sm">arrow_forward</span>
                    </button>
                </div>
            ` : '';

            container.innerHTML = servicesHtml + viewMoreButton;
        }

        // Enhanced Render Recent Activity
        function renderRecentActivity() {
            const container = document.getElementById('recentActivity');
            if (!container) return;
            
            const recentAppointments = [...dashboardData.pastAppointments, ...dashboardData.upcomingAppointments]
                .sort((a, b) => new Date(b.datetimeCreated) - new Date(a.datetimeCreated))
                .slice(0, 6);

            if (!recentAppointments.length) {
                container.innerHTML = `
                    <div class="p-8 text-center">
                        <div class="w-16 h-16 mx-auto mb-4 bg-green-100 dark:bg-green-900/20 rounded-2xl flex items-center justify-center">
                            <span class="material-icons text-green-500 text-2xl">timeline</span>
                        </div>
                        <p class="text-theme-text-secondary">No recent activity</p>
                    </div>
                `;
                return;
            }

            const activitiesHtml = recentAppointments.map((apt, index) => {
                const isPast = new Date(apt.datetime) < new Date();
                const actionText = isPast ? (apt.canceled ? 'cancelled' : 'completed') : 'scheduled';
                const iconName = isPast ? (apt.canceled ? 'cancel' : 'check_circle') : 'event_note';
                const iconColor = isPast ? (apt.canceled ? 'text-red-500' : 'text-emerald-500') : 'text-blue-500';
                const bgColor = isPast ? (apt.canceled ? 'bg-red-50 dark:bg-red-900/20' : 'bg-emerald-50 dark:bg-emerald-900/20') : 'bg-blue-50 dark:bg-blue-900/20';
                const service = dashboardData.services.find(s => s.id === apt.appointmentTypeID);
                const price = apt.priceSold || apt.price || (service ? service.price : 0);

                return `
                    <div class="p-6 hover:bg-theme-bg-accent transition-all duration-300 group animate-slide-in" style="animation-delay: ${index * 0.1}s">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 rounded-xl ${bgColor} flex items-center justify-center group-hover:shadow-lg transition-all duration-300 transform group-hover:scale-110">
                                    <span class="material-icons ${iconColor} text-lg">${iconName}</span>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between mb-2">
                                    <p class="text-base font-bold text-theme-text-primary">
                                        ${apt.firstName} ${apt.lastName}
                                    </p>
                                    <span class="text-sm font-bold text-theme-text-primary">$${parseFloat(price).toFixed(2)}</span>
                                </div>
                                <p class="text-sm text-theme-text-secondary mb-3">
                                    ${actionText} <span class="font-semibold text-theme-primary">${apt.type}</span>
                                </p>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-theme-text-secondary">${formatRelativeTime(new Date(apt.datetimeCreated))}</span>
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${
                                        isPast 
                                            ? (apt.canceled ? 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-300' : 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/20 dark:text-emerald-300')
                                            : 'bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-300'
                                    }">
                                        ${actionText}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            const viewMoreButton = `
                <div class="p-6 bg-theme-bg-accent">
                    <button onclick="showAllActivity()" class="btn-view-more w-full text-center py-3 px-6 text-sm font-semibold flex items-center justify-center space-x-2">
                        <span>View All Activity</span>
                        <span class="material-icons text-sm">timeline</span>
                    </button>
                </div>
            `;

            container.innerHTML = activitiesHtml + viewMoreButton;
        }

        // Enhanced Render Top Clients
        function renderTopClients() {
            const container = document.getElementById('topClients');
            if (!container || !dashboardData.analytics) return;
            
            const clients = dashboardData.analytics.clients.topClients.slice(0, 5);
            const totalClients = dashboardData.analytics.clients.totalClients;

            if (!clients.length) {
                container.innerHTML = `
                    <div class="p-8 text-center">
                        <div class="w-16 h-16 mx-auto mb-4 bg-purple-100 dark:bg-purple-900/20 rounded-2xl flex items-center justify-center">
                            <span class="material-icons text-purple-500 text-2xl">stars</span>
                        </div>
                        <p class="text-theme-text-secondary">No clients data available</p>
                    </div>
                `;
                return;
            }

            const clientsHtml = clients.map((client, index) => {
                const initials = client.name.split(' ').map(n => n[0]).join('').toUpperCase();
                const isVIP = client.totalSpent > 500;
                const lastVisit = client.lastVisit ? new Date(client.lastVisit) : null;
                const daysSinceLastVisit = lastVisit ? Math.floor((new Date() - lastVisit) / (1000 * 60 * 60 * 24)) : null;

                return `
                    <div class="p-6 hover:bg-theme-bg-accent transition-all duration-300 group animate-slide-in" style="animation-delay: ${index * 0.1}s">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="flex-shrink-0 relative">
                                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-theme-primary/20 to-theme-primary/40 flex items-center justify-center text-theme-primary font-bold text-base shadow-lg group-hover:shadow-xl transition-all duration-300 transform group-hover:scale-110">
                                        ${initials}
                                    </div>
                                    ${isVIP ? '<div class="absolute -top-1 -right-1 w-5 h-5 bg-gradient-to-r from-yellow-400 to-orange-400 rounded-full flex items-center justify-center"><span class="material-icons text-xs text-white">star</span></div>' : ''}
                                </div>
                                <div>
                                    <div class="flex items-center space-x-3 mb-2">
                                        <p class="text-base font-bold text-theme-text-primary">${client.name}</p>
                                        ${isVIP ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-300">VIP</span>' : ''}
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-800 dark:bg-emerald-900/20 dark:text-emerald-300">
                                            ${client.appointments.length} visits
                                        </span>
                                        ${daysSinceLastVisit !== null ? `<span class="text-xs text-theme-text-secondary"> ${daysSinceLastVisit}d ago</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-bold text-theme-text-primary">$${client.totalSpent.toFixed(2)}</p>
                                <p class="text-sm text-theme-text-secondary font-semibold">
                                    $${(client.totalSpent / client.appointments.length).toFixed(0)} avg
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            const viewMoreButton = totalClients > 5 ? `
                <div class="p-6 bg-theme-bg-accent">
                    <button onclick="showAllClients()" class="btn-view-more w-full text-center py-3 px-6 text-sm font-semibold flex items-center justify-center space-x-2">
                        <span>View All ${totalClients} Clients</span>
                        <span class="material-icons text-sm">arrow_forward</span>
                    </button>
                </div>
            ` : '';

            container.innerHTML = clientsHtml + viewMoreButton;
        }

        // Enhanced Render Upcoming Appointments
        function renderUpcomingAppointments() {
            const container = document.getElementById('upcomingAppointments');
            if (!container) return;
            
            const allUpcoming = dashboardData.upcomingAppointments
                .filter(apt => !apt.canceled)
                .sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
            
            const upcoming = allUpcoming.slice(0, 8);

            if (!upcoming.length) {
                container.innerHTML = `
                    <div class="p-12 text-center">
                        <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-blue-100 to-indigo-100 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-3xl flex items-center justify-center shadow-lg">
                            <span class="material-icons text-blue-500 text-4xl">event_available</span>
                        </div>
                        <h3 class="text-2xl font-bold text-theme-text-primary mb-3">No upcoming appointments</h3>
                        <p class="text-theme-text-secondary text-lg mb-6">Your schedule is clear. New appointments will appear here.</p>
                        <button onclick="openAnonymousScheduling()" class="btn-modern inline-flex items-center">
                            <span class="material-icons text-sm mr-2">add</span>
                            Schedule Appointment
                        </button>
                    </div>
                `;
                return;
            }

            const appointmentsHtml = upcoming.map((apt, index) => {
                const appointmentDate = new Date(apt.datetime);
                const isToday = appointmentDate.toDateString() === new Date().toDateString();
                const isTomorrow = appointmentDate.toDateString() === new Date(Date.now() + 86400000).toDateString();
                const isThisWeek = appointmentDate <= new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
                
                let dateLabel = formatDate(apt.datetime);
                let dateColor = 'text-theme-text-secondary';
                let urgencyClass = 'border-l-theme-primary';
                
                if (isToday) {
                    dateLabel = 'Today';
                    dateColor = 'text-red-600 font-bold';
                    urgencyClass = 'border-l-red-400 bg-red-50 dark:bg-red-900/20';
                } else if (isTomorrow) {
                    dateLabel = 'Tomorrow';
                    dateColor = 'text-orange-600 font-bold';
                    urgencyClass = 'border-l-orange-400 bg-orange-50 dark:bg-orange-900/20';
                } else if (isThisWeek) {
                    dateColor = 'text-blue-600 font-semibold';
                }

                const service = dashboardData.services.find(s => s.id === apt.appointmentTypeID);
                const price = apt.priceSold || apt.price || (service ? service.price : 0);

                return `
                    <div class="p-6 hover:bg-theme-bg-accent transition-all duration-300 group border-l-4 ${urgencyClass} animate-slide-in" style="animation-delay: ${index * 0.1}s">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-6 flex-1">
                                <div class="flex-shrink-0">
                                    <div class="w-16 h-16 rounded-2xl flex items-center justify-center shadow-lg group-hover:shadow-xl transition-all duration-300 transform group-hover:scale-110" 
                                         style="background: linear-gradient(135deg, ${service?.color || '#6b7280'}20, ${service?.color || '#6b7280'}40)">
                                        <span class="material-icons text-2xl" style="color: ${service?.color || '#6b7280'}">person</span>
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between mb-3">
                                        <h5 class="text-xl font-bold text-theme-text-primary">${apt.firstName} ${apt.lastName}</h5>
                                        <span class="text-xl font-bold text-emerald-600">$${parseFloat(price).toFixed(2)}</span>
                                    </div>
                                    <div class="flex items-center space-x-4 mb-2">
                                        <span class="inline-flex items-center px-4 py-2 rounded-xl text-sm font-semibold bg-theme-primary/10 text-theme-primary shadow-sm">
                                            ${apt.type}
                                        </span>
                                        ${service?.duration ? `<span class="text-sm text-theme-text-secondary font-medium"> ${service.duration} min</span>` : ''}
                                        ${apt.phone ? `<span class="text-sm text-theme-text-secondary font-medium"> ${apt.phone}</span>` : ''}
                                    </div>
                                    ${apt.email ? `<p class="text-sm text-theme-text-secondary mt-2">${apt.email}</p>` : ''}
                                </div>
                            </div>
                            <div class="text-right ml-6">
                                <p class="text-xl font-bold ${dateColor} mb-1">${dateLabel}</p>
                                <p class="text-base text-theme-text-primary font-semibold mb-3">${apt.time} - ${apt.endTime}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            const viewMoreButton = allUpcoming.length > 8 ? `
                <div class="p-6 bg-theme-bg-accent">
                    <button onclick="viewAllUpcoming()" class="btn-view-more w-full text-center py-4 px-6 text-sm font-semibold flex items-center justify-center space-x-2 border-2 border-theme-primary/20 hover:border-theme-primary/40">
                        <span>View All ${allUpcoming.length} Upcoming Appointments</span>
                        <span class="material-icons text-sm">arrow_forward</span>
                    </button>
                </div>
            ` : '';

            container.innerHTML = appointmentsHtml + viewMoreButton;
        }

        // Utility Functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        function formatRelativeTime(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            return `${Math.floor(diffInSeconds / 86400)}d ago`;
        }

        // View More Functions (placeholder implementations)
        function showAllServices() {
            alert('Show all services feature - to be implemented');
        }

        function showAllActivity() {
            alert('Show all activity feature - to be implemented');
        }

        function showAllClients() {
            alert('Show all clients feature - to be implemented');
        }

        function viewAllUpcoming() {
            window.location.href = 'appointments.html?type=upcoming';
        }

        // Enhanced Refresh Dashboard
        async function refreshDashboard() {
            try {
                showLoadingState();
                
                // Clear localStorage to force fresh data fetch
                localStorage.removeItem('appointmentTypes');
                localStorage.removeItem('upcomingAppointments');
                localStorage.removeItem('pastAppointments');
                localStorage.removeItem('userData');
                localStorage.removeItem('services');
                
                // Reset data loaded flag
                dashboardData.isDataLoaded = false;
                
                await fetchAllData();
                await loadAndProcessData();
                dashboardData.isDataLoaded = true;
                renderDashboard();
                
                // Destroy existing charts before recreating
                Object.values(analyticsConfig.charts).forEach(chart => {
                    if (chart && typeof chart.destroy === 'function') {
                        chart.destroy();
                    }
                });
                analyticsConfig.charts = {};
                
                setTimeout(() => {
                    initializeCharts();
                    document.querySelectorAll('.loading-placeholder').forEach(el => {
                        el.classList.add('hidden');
                    });
                }, 500);
                
                // Show success message
                showToast('Dashboard refreshed successfully!', 'success');
            } catch (error) {
                console.error("Error refreshing dashboard:", error);
                showErrorState();
                showToast('Error refreshing dashboard. Please try again.', 'error');
            }
        }

        // Toast Notification Function
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-emerald-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-4 rounded-xl shadow-lg z-50 transform translate-x-full transition-transform duration-300`;
            toast.innerHTML = `
                <div class="flex items-center space-x-3">
                    <span class="material-icons text-sm">${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info'}</span>
                    <span class="font-medium">${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Export Functions
        function exportDashboardReport() {
            const reportData = {
                generatedOn: new Date().toISOString(),
                businessName: dashboardData.userData.name,
                period: 'All Time',
                overview: dashboardData.analytics.overview,
                topServices: dashboardData.analytics.services.popular.slice(0, 10),
                topClients: dashboardData.analytics.clients.topClients.slice(0, 10),
                revenueAnalytics: dashboardData.analytics.revenue
            };

            const dataStr = JSON.stringify(reportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `dashboard-report-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('Report exported successfully!', 'success');
        }

        // Add detail popup functions
        function showAppointmentDetails(appointmentId) {
            const appointment = [...dashboardData.pastAppointments, ...dashboardData.upcomingAppointments]
                .find(apt => apt.id == appointmentId);
            
            if (!appointment) return;
            
            const service = dashboardData.services.find(s => s.id === appointment.appointmentTypeID);
            const isPast = new Date(appointment.datetime) < new Date();
            const status = appointment.canceled ? 'Cancelled' : (isPast ? 'Completed' : 'Scheduled');
            const price = appointment.priceSold || appointment.price || (service ? service.price : 0);

            hideSearchResults();
            
            const modal = createDetailModal('Appointment Details', `
                <div class="space-y-6">
                    <div class="flex items-start justify-between">
                        <div>
                            <h3 class="text-2xl font-bold text-theme-text-primary">${appointment.firstName} ${appointment.lastName}</h3>
                            <p class="text-theme-text-secondary mt-1">${appointment.email || 'No email'}  ${appointment.phone || 'No phone'}</p>
                        </div>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold ${
                            appointment.canceled ? 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-300' : 
                            (isPast ? 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/20 dark:text-emerald-300' : 
                            'bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-300')
                        }">
                            ${status}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm font-medium text-theme-text-secondary">Service</label>
                                <p class="text-lg font-semibold text-theme-text-primary">${appointment.type}</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-theme-text-secondary">Date & Time</label>
                                <p class="text-lg font-semibold text-theme-text-primary">${appointment.date}</p>
                                <p class="text-theme-text-secondary">${appointment.time} - ${appointment.endTime}</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-theme-text-secondary">Duration</label>
                                <p class="text-lg font-semibold text-theme-text-primary">${service?.duration || appointment.duration || 'N/A'} minutes</p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm font-medium text-theme-text-secondary">Price</label>
                                <p class="text-2xl font-bold text-emerald-600">$${parseFloat(price).toFixed(2)}</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-theme-text-secondary">Payment Status</label>
                                <p class="text-lg font-semibold text-theme-text-primary">${appointment.paid === 'yes' ? 'Paid' : 'Unpaid'}</p>
                                ${appointment.amountPaid && parseFloat(appointment.amountPaid) > 0 ? `<p class="text-theme-text-secondary">Amount Paid: $${parseFloat(appointment.amountPaid).toFixed(2)}</p>` : ''}
                            </div>
                            <div>
                                <label class="text-sm font-medium text-theme-text-secondary">Calendar</label>
                                <p class="text-lg font-semibold text-theme-text-primary">${appointment.calendar}</p>
                            </div>
                        </div>
                    </div>
                    
                    ${appointment.notes ? `
                        <div>
                            <label class="text-sm font-medium text-theme-text-secondary">Notes</label>
                            <p class="text-theme-text-primary bg-theme-bg-accent p-3 rounded-lg mt-1">${appointment.notes}</p>
                        </div>
                    ` : ''}
                    
                    <div class="text-xs text-theme-text-secondary">
                        <p>Created: ${new Date(appointment.datetimeCreated).toLocaleString()}</p>
                        <p>ID: ${appointment.id}</p>
                    </div>
                </div>
            `);
            
            document.body.appendChild(modal);
        }

        function showServiceDetails(serviceId) {
            const service = dashboardData.services.find(s => s.id == serviceId);
            if (!service) return;
            
            hideSearchResults();
            
            const modal = createDetailModal('Service Details', `
                <div class="space-y-6">
                    <div class="flex items-start justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-16 h-16 rounded-2xl flex items-center justify-center shadow-lg" 
                                 style="background: linear-gradient(135deg, ${service.color}20, ${service.color}40)">
                                <span class="material-icons text-2xl" style="color: ${service.color}">spa</span>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold text-theme-text-primary">${service.name}</h3>
                                <p class="text-theme-text-secondary mt-1">${service.category}</p>
                            </div>
                        </div>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold ${
                            service.active ? 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/20 dark:text-emerald-300' : 
                            'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-300'
                        }">
                            ${service.active ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center p-4 bg-theme-bg-accent rounded-lg">
                            <p class="text-3xl font-bold text-theme-primary">$${service.price}</p>
                            <p class="text-sm text-theme-text-secondary">Price</p>
                        </div>
                        <div class="text-center p-4 bg-theme-bg-accent rounded-lg">
                            <p class="text-3xl font-bold text-theme-primary">${service.duration}</p>
                            <p class="text-sm text-theme-text-secondary">Minutes</p>
                        </div>
                        <div class="text-center p-4 bg-theme-bg-accent rounded-lg">
                            <p class="text-3xl font-bold text-theme-primary">${service.bookingCount}</p>
                            <p class="text-sm text-theme-text-secondary">Bookings</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="text-sm font-medium text-theme-text-secondary">Total Revenue</label>
                            <p class="text-xl font-bold text-emerald-600">$${service.revenue.toFixed(2)}</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-theme-text-secondary">Average Revenue per Booking</label>
                            <p class="text-xl font-bold text-theme-text-primary">$${(service.revenue / service.bookingCount || 0).toFixed(2)}</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-theme-text-secondary">Last Booked</label>
                            <p class="text-lg font-semibold text-theme-text-primary">${service.lastBooked ? new Date(service.lastBooked).toLocaleDateString() : 'Never'}</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-theme-text-secondary">Service ID</label>
                            <p class="text-lg font-semibold text-theme-text-primary">${service.id}</p>
                        </div>
                    </div>
                </div>
            `);
            
            document.body.appendChild(modal);
        }

        function showClientDetails(clientName) {
            const client = dashboardData.analytics.clients.allClients.find(c => c.name === clientName);
            if (!client) return;
            
            hideSearchResults();
            
            const recentAppointments = client.appointments
                .sort((a, b) => new Date(b.datetime) - new Date(a.datetime))
                .slice(0, 5);
            
            const modal = createDetailModal('Client Details', `
                <div class="space-y-6">
                    <div class="flex items-start justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-theme-primary/20 to-theme-primary/40 flex items-center justify-center text-theme-primary font-bold text-xl shadow-lg">
                                ${client.name.split(' ').map(n => n[0]).join('').toUpperCase()}
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold text-theme-text-primary">${client.name}</h3>
                                <p class="text-theme-text-secondary mt-1">${client.email || 'No email'}  ${client.phone || 'No phone'}</p>
                            </div>
                        </div>
                        ${client.totalSpent > 500 ? '<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-300">VIP Client</span>' : ''}
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center p-4 bg-theme-bg-accent rounded-lg">
                            <p class="text-3xl font-bold text-emerald-600">$${client.totalSpent.toFixed(2)}</p>
                            <p class="text-sm text-theme-text-secondary">Total Spent</p>
                        </div>
                        <div class="text-center p-4 bg-theme-bg-accent rounded-lg">
                            <p class="text-3xl font-bold text-theme-primary">${client.appointments.length}</p>
                            <p class="text-sm text-theme-text-secondary">Total Visits</p>
                        </div>
                        <div class="text-center p-4 bg-theme-bg-accent rounded-lg">
                            <p class="text-3xl font-bold text-theme-primary">$${(client.totalSpent / client.appointments.length).toFixed(2)}</p>
                            <p class="text-sm text-theme-text-secondary">Avg per Visit</p>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-lg font-semibold text-theme-text-primary mb-4">Recent Appointments</h4>
                        <div class="space-y-3 max-h-64 overflow-y-auto hide-scrollbar">
                            ${recentAppointments.map(apt => {
                                const isPast = new Date(apt.datetime) < new Date();
                                const status = apt.canceled ? 'Cancelled' : (isPast ? 'Completed' : 'Scheduled');
                                const statusColor = apt.canceled ? 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-300' : 
                                          (isPast ? 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/20 dark:text-emerald-300' : 
                                          'bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-300');
                                
                                return `
                                    <div class="flex items-center justify-between p-3 bg-theme-bg-accent rounded-lg">
                                        <div>
                                            <p class="font-medium text-theme-text-primary">${apt.type}</p>
                                            <p class="text-sm text-theme-text-secondary">${apt.date}  ${apt.time}</p>
                                        </div>
                                        <div class="text-right">
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold ${statusColor}">
                                                ${status}
                                            </span>
                                            <p class="text-sm font-semibold text-theme-text-primary mt-1">$${parseFloat(apt.priceSold || apt.price || 0).toFixed(2)}</p>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `);
            
            document.body.appendChild(modal);
        }

        // Generic detail modal creator
        function createDetailModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 animate-fade-in';
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };

            modal.innerHTML = `
                <div class="bg-theme-bg-primary rounded-3xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden animate-slide-in">
                    <div class="p-6 border-b border-theme-border bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20">
                        <div class="flex items-center justify-between">
                            <h2 class="text-2xl font-bold text-theme-text-primary">${title}</h2>
                            <button onclick="this.closest('.fixed').remove()" class="p-2 rounded-full text-theme-text-secondary hover:text-theme-text-primary hover:bg-theme-bg-accent transition-all duration-200 transform hover:scale-110">
                                <span class="material-icons">close</span>
                            </button>
                        </div>
                    </div>
                    <div class="overflow-y-auto max-h-[calc(90vh-100px)] hide-scrollbar">
                        <div class="p-6">
                            ${content}
                        </div>
                    </div>
                </div>
            `;

            return modal;
        }

        // Add help function for the ? button
        function showHelpModal() {
            const modal = createDetailModal('Analytics Dashboard Help', `
                <div class="space-y-6">
                    <div class="text-center mb-6">
                        <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-br from-blue-100 to-indigo-100 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-3xl flex items-center justify-center">
                            <span class="material-icons text-blue-500 text-3xl">help_outline</span>
                        </div>
                        <h3 class="text-xl font-bold text-theme-text-primary">Welcome to Your Analytics Dashboard</h3>
                        <p class="text-theme-text-secondary">Comprehensive insights for your business</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-theme-text-primary flex items-center">
                                <span class="material-icons text-blue-500 mr-2">dashboard</span>
                                Key Features
                            </h4>
                            <ul class="space-y-2 text-theme-text-secondary">
                                <li class="flex items-center"><span class="material-icons text-sm text-green-500 mr-2">check_circle</span>Real-time revenue tracking</li>
                                <li class="flex items-center"><span class="material-icons text-sm text-green-500 mr-2">check_circle</span>Appointment analytics</li>
                                <li class="flex items-center"><span class="material-icons text-sm text-green-500 mr-2">check_circle</span>Service performance metrics</li>
                                <li class="flex items-center"><span class="material-icons text-sm text-green-500 mr-2">check_circle</span>Client management insights</li>
                                <li class="flex items-center"><span class="material-icons text-sm text-green-500 mr-2">check_circle</span>Interactive charts and graphs</li>
                            </ul>
                        </div>
                        
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-theme-text-primary flex items-center">
                                <span class="material-icons text-purple-500 mr-2">search</span>
                                Search & Navigation
                            </h4>
                            <ul class="space-y-2 text-theme-text-secondary">
                                <li class="flex items-center"><span class="material-icons text-sm text-purple-500 mr-2">arrow_forward</span>Search appointments, services, and clients</li>
                                <li class="flex items-center"><span class="material-icons text-sm text-purple-500 mr-2">arrow_forward</span>Click on search results for detailed views</li>
                                <li class="flex items-center"><span class="material-icons text-sm text-purple-500 mr-2">arrow_forward</span>Use theme switcher for personalization</li>
                                <li class="flex items-center"><span class="material-icons text-sm text-purple-500 mr-2">arrow_forward</span>Export reports for external analysis</li>
                                <li class="flex items-center"><span class="material-icons text-sm text-purple-500 mr-2">arrow_forward</span>Schedule new appointments directly</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 p-6 rounded-lg">
                        <h4 class="text-lg font-semibold text-theme-text-primary mb-3 flex items-center">
                            <span class="material-icons text-orange-500 mr-2">lightbulb</span>
                            Quick Tips
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-theme-text-secondary">
                            <div>
                                <p class="font-medium mb-1"> Dashboard Overview:</p>
                                <p>Monitor key metrics like revenue, appointments, and success rates at a glance.</p>
                            </div>
                            <div>
                                <p class="font-medium mb-1"> Charts & Analytics:</p>
                                <p>Interactive charts show trends, peak hours, and service performance over time.</p>
                            </div>
                            <div>
                                <p class="font-medium mb-1"> Client Management:</p>
                                <p>Track top clients, spending patterns, and appointment history.</p>
                            </div>
                            <div>
                                <p class="font-medium mb-1"> Data Refresh:</p>
                                <p>Use the refresh button to update data and see the latest information.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            
            document.body.appendChild(modal);
        }

        // Replace the View More functions with proper modal implementations
        function showAllServices() {
            const services = dashboardData.analytics.services.all.sort((a, b) => b.revenue - a.revenue);
            
            const modal = createDetailModal('All Services', `
                <div class="space-y-4">
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-theme-text-secondary">Showing all ${services.length} services sorted by revenue</p>
                        <div class="flex space-x-2">
                            <button onclick="sortServices('revenue')" class="px-3 py-1 text-xs bg-theme-bg-accent rounded-lg text-theme-text-secondary hover:bg-theme-primary hover:text-white">Revenue</button>
                            <button onclick="sortServices('bookings')" class="px-3 py-1 text-xs bg-theme-bg-accent rounded-lg text-theme-text-secondary hover:bg-theme-primary hover:text-white">Bookings</button>
                            <button onclick="sortServices('name')" class="px-3 py-1 text-xs bg-theme-bg-accent rounded-lg text-theme-text-secondary hover:bg-theme-primary hover:text-white">Name</button>
                        </div>
                    </div>
                    <div class="max-h-96 overflow-y-auto hide-scrollbar space-y-2">
                        ${services.map(service => `
                            <div class="flex items-center justify-between p-4 bg-theme-bg-accent rounded-lg hover:bg-theme-bg-primary transition-all cursor-pointer" onclick="showServiceDetails('${service.id}')">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 rounded-xl flex items-center justify-center shadow-lg" style="background-color: ${service.color}20">
                                        <span class="material-icons" style="color: ${service.color}">spa</span>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-theme-text-primary">${service.name}</p>
                                        <p class="text-sm text-theme-text-secondary">${service.duration} min  ${service.category}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-emerald-600">$${service.revenue.toFixed(2)}</p>
                                    <p class="text-sm text-theme-text-secondary">${service.bookingCount} bookings</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `);
            
            document.body.appendChild(modal);
        }

        function showAllActivity() {
            const allActivity = [...dashboardData.pastAppointments, ...dashboardData.upcomingAppointments]
                .sort((a, b) => new Date(b.datetimeCreated) - new Date(a.datetimeCreated));
            
            const modal = createDetailModal('All Activity', `
                <div class="space-y-4">
                    <p class="text-theme-text-secondary">Showing all ${allActivity.length} activities sorted by creation date</p>
                    <div class="max-h-96 overflow-y-auto hide-scrollbar space-y-2">
                        ${allActivity.map(apt => {
                            const isPast = new Date(apt.datetime) < new Date();
                            const status = apt.canceled ? 'Cancelled' : (isPast ? 'Completed' : 'Scheduled');
                            const statusColor = apt.canceled ? 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-300' : 
                                              (isPast ? 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/20 dark:text-emerald-300' : 
                                              'bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-300');
                            const service = dashboardData.services.find(s => s.id === apt.appointmentTypeID);
                            const price = apt.priceSold || apt.price || (service ? service.price : 0);
                            
                            return `
                                <div class="flex items-center justify-between p-4 bg-theme-bg-accent rounded-lg hover:bg-theme-bg-primary transition-all cursor-pointer" onclick="showAppointmentDetails('${apt.id}')">
                                    <div class="flex items-center space-x-4">
                                        <div class="w-12 h-12 rounded-xl flex items-center justify-center shadow-lg" style="background-color: ${service?.color || '#6b7280'}20">
                                            <span class="material-icons" style="color: ${service?.color || '#6b7280'}">person</span>
                                        </div>
                                        <div>
                                            <p class="font-semibold text-theme-text-primary">${apt.firstName} ${apt.lastName}</p>
                                            <p class="text-sm text-theme-text-secondary">${apt.type}</p>
                                            <p class="text-xs text-theme-text-secondary">${formatRelativeTime(new Date(apt.datetimeCreated))}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold ${statusColor} mb-2">
                                            ${status}
                                        </span>
                                        <p class="text-sm font-semibold text-theme-text-primary">$${parseFloat(price).toFixed(2)}</p>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `);
            
            document.body.appendChild(modal);
        }

        function showAllClients() {
            const clients = dashboardData.analytics.clients.allClients;
            
            const modal = createDetailModal('All Clients', `
                <div class="space-y-4">
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-theme-text-secondary">Showing all ${clients.length} clients sorted by total spending</p>
                        <div class="flex space-x-2">
                            <button onclick="sortClients('spending')" class="px-3 py-1 text-xs bg-theme-bg-accent rounded-lg text-theme-text-secondary hover:bg-theme-primary hover:text-white">Spending</button>
                            <button onclick="sortClients('visits')" class="px-3 py-1 text-xs bg-theme-bg-accent rounded-lg text-theme-text-secondary hover:bg-theme-primary hover:text-white">Visits</button>
                            <button onclick="sortClients('name')" class="px-3 py-1 text-xs bg-theme-bg-accent rounded-lg text-theme-text-secondary hover:bg-theme-primary hover:text-white">Name</button>
                        </div>
                    </div>
                    <div class="max-h-96 overflow-y-auto hide-scrollbar space-y-2">
                        ${clients.map(client => {
                            const initials = client.name.split(' ').map(n => n[0]).join('').toUpperCase();
                            const isVIP = client.totalSpent > 500;
                            
                            return `
                                <div class="flex items-center justify-between p-4 bg-theme-bg-accent rounded-lg hover:bg-theme-bg-primary transition-all cursor-pointer" onclick="showClientDetails('${client.name}')">
                                    <div class="flex items-center space-x-4">
                                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-theme-primary/20 to-theme-primary/40 flex items-center justify-center text-theme-primary font-bold shadow-lg">
                                            ${initials}
                                        </div>
                                        <div>
                                            <div class="flex items-center space-x-2">
                                                <p class="font-semibold text-theme-text-primary">${client.name}</p>
                                                ${isVIP ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-300">VIP</span>' : ''}
                                            </div>
                                            <p class="text-sm text-theme-text-secondary">${client.appointments.length} appointments</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold text-emerald-600">$${client.totalSpent.toFixed(2)}</p>
                                        <p class="text-sm text-theme-text-secondary">$${(client.totalSpent / client.appointments.length).toFixed(2)} avg</p>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `);
            
            document.body.appendChild(modal);
        }

        // Update the top navigation to remove notification bell and add help button
        function updateTopNavigation() {
            const topNav = document.querySelector('.flex.items-center.h-16');
            if (topNav) {
                const functionalButtons = topNav.querySelector('.ml-4.flex.items-center.space-x-2');
                if (functionalButtons) {
                    functionalButtons.innerHTML = `
                        <button onclick="refreshDashboard()" class="p-2 rounded-lg text-theme-text-secondary hover:bg-theme-bg-accent" title="Refresh Dashboard">
                            <span class="material-icons">refresh</span>
                        </button>
                        <button onclick="exportDashboardReport()" class="p-2 rounded-lg text-theme-text-secondary hover:bg-theme-bg-accent" title="Export Report">
                            <span class="material-icons">download</span>
                        </button>
                        <button onclick="openAnonymousScheduling()" class="p-2 rounded-lg text-theme-text-secondary hover:bg-theme-bg-accent" title="Schedule Appointment">
                            <span class="material-icons">calendar_today</span>
                        </button>
                        <button onclick="showHelpModal()" class="p-2 rounded-lg text-theme-text-secondary hover:bg-theme-bg-accent" title="Help & Information">
                            <span class="material-icons">help_outline</span>
                        </button>
                    `;
                }
            }
        }

        // Add CSS for hiding scrollbars globally
        document.addEventListener('DOMContentLoaded', function() {
            const style = document.createElement('style');
            style.textContent = `
                body, main, .overflow-y-auto, .overflow-auto {
                    scrollbar-width: none;
                    -ms-overflow-style: none;
                }
                body::-webkit-scrollbar, main::-webkit-scrollbar, .overflow-y-auto::-webkit-scrollbar, .overflow-auto::-webkit-scrollbar {
                    display: none;
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</head>
<body class="bg-theme-bg-secondary text-theme-text-primary font-sans antialiased min-h-screen transition-colors duration-300 hide-scrollbar">
    <div class="flex h-screen overflow-hidden">
        <!-- Modern Sidebar -->
        <div class="hidden lg:flex lg:flex-shrink-0">
            <div class="flex flex-col w-72 bg-theme-bg-primary border-r border-theme-border">
                <div class="flex items-center h-16 px-6 border-b border-theme-border">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 rounded-lg bg-theme-primary flex items-center justify-center">
                            <span class="material-icons text-white text-xl">spa</span>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-theme-text-primary">Acuity Scheduling</h2>
                            <p class="text-xs text-theme-text-secondary">by Xtracut</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex-1 flex flex-col pt-6 pb-4 overflow-y-auto scrollbar-hide">
                    <div class="px-6">
                        <h3 class="text-xs font-semibold uppercase tracking-wider text-theme-text-secondary mb-4">Analytics</h3>
                    </div>
                    <nav class="mt-2 flex-1 px-4 space-y-1">
                        <a href="overall_dashboard.html" class="group flex items-center px-4 py-3 text-sm font-medium rounded-lg bg-theme-bg-accent text-theme-primary border-l-4 border-theme-primary">
                            <span class="material-icons mr-3 text-theme-primary text-xl">dashboard</span>
                            Analytics Dashboard
                        </a>
                        <a href="upcomming_appointmets.html" class="group flex items-center px-4 py-3 text-sm font-medium rounded-lg text-theme-text-primary hover:bg-theme-bg-accent">
                            <span class="material-icons mr-3 text-theme-text-secondary text-xl">event</span>
                            Upcoming Appointments
                        </a>
                        <a href="past_appointments.html" class="group flex items-center px-4 py-3 text-sm font-medium rounded-lg text-theme-text-primary hover:bg-theme-bg-accent">
                            <span class="material-icons mr-3 text-theme-text-secondary text-xl">history</span>
                            Past Appointments
                        </a>
                        <a href="appointment_types.html" class="group flex items-center px-4 py-3 text-sm font-medium rounded-lg text-theme-text-primary hover:bg-theme-bg-accent">
                            <span class="material-icons mr-3 text-theme-text-secondary text-xl">spa</span>
                            Services
                        </a>
                    </nav>

                    <div class="px-6 mt-8">
                        <h3 class="text-xs font-semibold uppercase tracking-wider text-theme-text-secondary mb-4">Settings</h3>
                    </div>
                    <nav class="mt-2 flex-1 px-4 space-y-1">
                        <a href="profile.html" class="group flex items-center px-4 py-3 text-sm font-medium rounded-lg text-theme-text-primary hover:bg-theme-bg-accent">
                            <span class="material-icons mr-3 text-theme-text-secondary text-xl">person</span>
                            Profile
                        </a>
                        <a href="help_support.html" class="group flex items-center px-4 py-3 text-sm font-medium rounded-lg text-theme-text-primary hover:bg-theme-bg-accent">
                            <span class="material-icons mr-3 text-theme-text-secondary text-xl">help</span>
                            Help & Support
                        </a>
                    </nav>
                </div>
                
                <!-- User Profile Section -->
                <div class="p-4 border-t border-theme-border">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg bg-theme-primary/20 flex items-center justify-center text-theme-primary font-medium">
                            PK
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-theme-text-primary truncate">Prem Anand K</p>
                            <div class="flex items-center mt-1">
                                <div class="h-2 w-2 rounded-full bg-success-500 mr-2"></div>
                                <p class="text-xs text-theme-text-secondary">Online</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex flex-col flex-1 overflow-hidden">
            <!-- Top Navigation -->
            <div class="flex items-center h-16 bg-theme-bg-primary border-b border-theme-border px-4 lg:px-8">
                <button class="p-2 rounded-lg text-theme-text-secondary lg:hidden hover:bg-theme-bg-accent">
                    <span class="material-icons">menu</span>
                </button>
                
                <div class="flex-1 flex justify-center lg:justify-end max-w-lg ml-auto">
                    <div class="w-full">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="material-icons text-theme-text-secondary">search</span>
                            </div>
                            <input type="text" placeholder="Search analytics, clients, services..." class="block w-full pl-10 pr-4 py-2 rounded-lg border border-theme-border bg-theme-bg-accent focus:outline-none focus:ring-2 focus:ring-theme-primary focus:border-transparent text-sm text-theme-text-primary placeholder-theme-text-secondary">
                        </div>
                    </div>
                </div>
                
                <div class="ml-4 flex items-center space-x-2">
                    <button onclick="refreshDashboard()" class="p-2 rounded-lg text-theme-text-secondary hover:bg-theme-bg-accent" title="Refresh Dashboard">
                        <span class="material-icons">refresh</span>
                    </button>
                    <button onclick="exportDashboardReport()" class="p-2 rounded-lg text-theme-text-secondary hover:bg-theme-bg-accent" title="Export Report">
                        <span class="material-icons">download</span>
                    </button>
                    <button onclick="openAnonymousScheduling()" class="p-2 rounded-lg text-theme-text-secondary hover:bg-theme-bg-accent" title="Schedule Appointment">
                        <span class="material-icons">calendar_today</span>
                    </button>
                    <button onclick="showHelpModal()" class="p-2 rounded-lg text-theme-text-secondary hover:bg-theme-bg-accent" title="Help & Information">
                        <span class="material-icons">help_outline</span>
                    </button>
                </div>
            </div>

            <!-- Page Content -->
            <main class="flex-1 overflow-auto p-6 bg-theme-bg-secondary">
                <!-- Content will be dynamically inserted here -->
            </main>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <div class="lg:hidden fixed bottom-0 left-0 right-0 bg-theme-bg-primary border-t border-theme-border px-4 py-2 z-50">
        <div class="flex justify-around items-center">
            <a href="overall_dashboard.html" class="flex flex-col items-center p-2 text-theme-primary">
                <span class="material-icons text-lg">dashboard</span>
                <span class="text-xs mt-1 font-medium">Analytics</span>
            </a>
            <a href="upcomming_appointmets.html" class="flex flex-col items-center p-2 text-theme-text-secondary">
                <span class="material-icons text-lg">event</span>
                <span class="text-xs mt-1">Upcoming</span>
            </a>
            <a href="past_appointments.html" class="flex flex-col items-center p-2 text-theme-text-secondary">
                <span class="material-icons text-lg">history</span>
                <span class="text-xs mt-1">Past</span>
            </a>
            <a href="profile.html" class="flex flex-col items-center p-2 text-theme-text-secondary">
                <span class="material-icons text-lg">person</span>
                <span class="text-xs mt-1">Profile</span>
            </a>
        </div>
    </div>

    <!-- Theme Switcher -->
    <div id="theme-switcher-container"></div>

    <!-- New Appointment Modal -->
    <div id="newAppointmentModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-theme-bg-primary rounded-lg shadow-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b border-theme-border">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold text-theme-text-primary">Schedule New Appointment</h2>
                            <p class="text-theme-text-secondary mt-1">Create a new appointment booking</p>
                        </div>
                        <button onclick="closeNewAppointmentModal()" class="p-2 rounded-lg text-theme-text-secondary hover:text-theme-text-primary hover:bg-theme-bg-accent">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                </div>
                
                <form id="newAppointmentForm" class="p-6 space-y-6">
                    <!-- Client Information -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-theme-text-primary flex items-center">
                            <span class="material-icons text-theme-primary mr-2">person</span>
                            Client Information
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-theme-text-secondary mb-1">First Name *</label>
                                <input type="text" id="firstName" required class="w-full px-3 py-2 border border-theme-border rounded-lg focus:ring-2 focus:ring-theme-primary focus:border-transparent text-sm bg-theme-bg-secondary text-theme-text-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-theme-text-secondary mb-1">Last Name *</label>
                                <input type="text" id="lastName" required class="w-full px-3 py-2 border border-theme-border rounded-lg focus:ring-2 focus:ring-theme-primary focus:border-transparent text-sm bg-theme-bg-secondary text-theme-text-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-theme-text-secondary mb-1">Email *</label>
                                <input type="email" id="email" required class="w-full px-3 py-2 border border-theme-border rounded-lg focus:ring-2 focus:ring-theme-primary focus:border-transparent text-sm bg-theme-bg-secondary text-theme-text-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-theme-text-secondary mb-1">Phone</label>
                                <input type="tel" id="phone" class="w-full px-3 py-2 border border-theme-border rounded-lg focus:ring-2 focus:ring-theme-primary focus:border-transparent text-sm bg-theme-bg-secondary text-theme-text-primary">
                            </div>
                        </div>
                    </div>

                    <!-- Service Selection -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-theme-text-primary flex items-center">
                            <span class="material-icons text-theme-primary mr-2">spa</span>
                            Service Details
                        </h3>
                        <div>
                            <label class="block text-sm font-medium text-theme-text-secondary mb-1">Select Service *</label>
                            <select id="serviceSelect" required class="w-full px-3 py-2 border border-theme-border rounded-lg focus:ring-2 focus:ring-theme-primary focus:border-transparent text-sm bg-theme-bg-secondary text-theme-text-primary">
                                <option value="">Choose a service...</option>
                            </select>
                        </div>
                        <div id="serviceDetails" class="hidden bg-theme-bg-accent rounded-lg p-4 border border-theme-border">
                            <!-- Service details will be populated here -->
                        </div>
                    </div>

                    <!-- Date & Time -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-theme-text-primary flex items-center">
                            <span class="material-icons text-theme-primary mr-2">schedule</span>
                            Date & Time
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-theme-text-secondary mb-1">Date *</label>
                                <input type="date" id="appointmentDate" required class="w-full px-3 py-2 border border-theme-border rounded-lg focus:ring-2 focus:ring-theme-primary focus:border-transparent text-sm bg-theme-bg-secondary text-theme-text-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-theme-text-secondary mb-1">Time *</label>
                                <input type="time" id="appointmentTime" required class="w-full px-3 py-2 border border-theme-border rounded-lg focus:ring-2 focus:ring-theme-primary focus:border-transparent text-sm bg-theme-bg-secondary text-theme-text-primary">
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div>
                        <label class="block text-sm font-medium text-theme-text-secondary mb-1">Notes</label>
                        <textarea id="notes" rows="3" class="w-full px-3 py-2 border border-theme-border rounded-lg focus:ring-2 focus:ring-theme-primary focus:border-transparent text-sm bg-theme-bg-secondary text-theme-text-primary" placeholder="Any special requirements or notes..."></textarea>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex items-center justify-end space-x-3 pt-4 border-t border-theme-border">
                        <button type="button" onclick="closeNewAppointmentModal()" class="px-4 py-2 border border-theme-border rounded-lg text-theme-text-secondary hover:bg-theme-bg-accent text-sm font-medium">
                            Cancel
                        </button>
                        <button type="submit" class="btn-modern px-4 py-2 text-sm font-medium">
                            Schedule Appointment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Anonymous Scheduling Modal -->
    <div id="anonymousSchedulingModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-theme-bg-primary rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden">
                <div class="p-6 border-b border-theme-border bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20">
                    <div class="flex items-center justify-between">
                        <h2 class="text-2xl font-bold text-theme-text-primary">Schedule Appointment</h2>
                        <button onclick="closeAnonymousScheduling()" class="p-2 rounded-full text-theme-text-secondary hover:text-theme-text-primary hover:bg-theme-bg-accent">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                </div>
                <div class="relative" style="height: 700px;">
                    <div id="schedulingLoader" class="absolute inset-0 bg-theme-bg-primary flex items-center justify-center z-10">
                        <div class="text-center">
                            <div class="w-16 h-16 border-4 border-theme-primary border-t-transparent rounded-full animate-spin mb-4 mx-auto"></div>
                            <p class="text-theme-text-primary font-medium">Loading scheduling page...</p>
                        </div>
                    </div>
                    <iframe id="schedulingFrame" src="" width="100%" height="100%" frameborder="0" class="absolute inset-0" style="display: none;"></iframe>
                </div>
            </div>
        </div>
    </div>
</body>
</html>