<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bio revive by SkinEnvy - Analytics Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="../../js/lib/jquery-3.3.1.min.js"></script>
    <script src="../../js/lib/ZohoEmbededAppSDK.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eef9ff',
                            100: '#dcf2ff',
                            200: '#b3e8ff',
                            300: '#83d9ff',
                            400: '#48c2ff',
                            500: '#1aa1ff',
                            600: '#0080f5',
                            700: '#0067d9',
                            800: '#0055b0',
                            900: '#064b8d',
                        },
                        success: {
                            50: '#f0fdf4',
                            500: '#22c55e',
                            600: '#16a34a',
                        },
                        warning: {
                            50: '#fffbeb',
                            500: '#f59e0b',
                            600: '#d97706',
                        },
                        danger: {
                            50: '#fef2f2',
                            500: '#ef4444',
                            600: '#dc2626',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        card: '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)',
                        'card-hover': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        'card-lg': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .gradient-border {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1px;
            border-radius: 12px;
        }
        .gradient-border-content {
            background: white;
            border-radius: 11px;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .service-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 9999px;
            border: 1px solid transparent;
        }
    </style>
    <script>
        // Enhanced Global Data Structure
        let dashboardData = {
            appointmentTypes: [],
            upcomingAppointments: [],
            pastAppointments: [],
            userData: {},
            services: [],
            analytics: {}
        };

        // Analytics Configuration
        const analyticsConfig = {
            charts: {},
            colors: {
                primary: '#0080f5',
                success: '#22c55e',
                warning: '#f59e0b',
                danger: '#ef4444',
                purple: '#8b5cf6',
                teal: '#14b8a6',
                orange: '#f97316',
                pink: '#ec4899'
            }
        };

        // Initialize Dashboard
        document.addEventListener("DOMContentLoaded", function() {
            ZOHO.embeddedApp.init()
                .then(function() {
                    console.log("ZOHO SDK initialized successfully");
                    initializeDashboard();
                })
                .catch(function(error) {
                    console.error("Error initializing dashboard:", error);
                    showErrorState();
                });
        });

        // Enhanced Dashboard Initialization
        async function initializeDashboard() {
            try {
                showLoadingState();
                await loadAndProcessData();
                renderDashboard();
                initializeCharts();
            } catch (error) {
                console.error("Error initializing dashboard:", error);
                showErrorState();
            }
        }

        // Load and Process All Data
        async function loadAndProcessData() {
            try {
                // Check if data exists in localStorage
                const storedData = {
                    appointmentTypes: localStorage.getItem('appointmentTypes'),
                    upcomingAppointments: localStorage.getItem('upcomingAppointments'),
                    pastAppointments: localStorage.getItem('pastAppointments'),
                    userData: localStorage.getItem('userData'),
                    services: localStorage.getItem('services')
                };

                // If no data in localStorage, fetch from API
                if (!storedData.appointmentTypes || !storedData.upcomingAppointments || !storedData.pastAppointments || !storedData.userData) {
                    console.log("Fetching data from API...");
                    await fetchAllData();
                }

                // Load data into global object
                dashboardData.appointmentTypes = JSON.parse(localStorage.getItem('appointmentTypes') || '[]');
                dashboardData.upcomingAppointments = JSON.parse(localStorage.getItem('upcomingAppointments') || '[]');
                dashboardData.pastAppointments = JSON.parse(localStorage.getItem('pastAppointments') || '[]');
                dashboardData.userData = JSON.parse(localStorage.getItem('userData') || '{}');
                dashboardData.services = JSON.parse(localStorage.getItem('services') || '[]');

                // Process and store services separately
                processAndStoreServices();
                
                // Generate analytics
                generateAnalytics();

                console.log("Dashboard data loaded successfully:", dashboardData);
            } catch (error) {
                console.error("Error loading dashboard data:", error);
                throw error;
            }
        }

        // Process and Store Services Separately
        function processAndStoreServices() {
            const services = dashboardData.appointmentTypes.map(type => ({
                id: type.id,
                name: type.name,
                category: type.category || 'General',
                duration: type.duration,
                price: parseFloat(type.price),
                color: type.color,
                active: type.active,
                bookingCount: 0,
                revenue: 0,
                lastBooked: null
            }));

            // Calculate booking statistics
            const allAppointments = [...dashboardData.pastAppointments, ...dashboardData.upcomingAppointments];
            
            allAppointments.forEach(appointment => {
                const service = services.find(s => s.id === appointment.appointmentTypeID);
                if (service && !appointment.canceled) {
                    service.bookingCount++;
                    service.revenue += parseFloat(appointment.priceSold || appointment.price || 0);
                    if (!service.lastBooked || new Date(appointment.datetime) > new Date(service.lastBooked)) {
                        service.lastBooked = appointment.datetime;
                    }
                }
            });

            dashboardData.services = services;
            localStorage.setItem('services', JSON.stringify(services));
        }

        // Generate Comprehensive Analytics
        function generateAnalytics() {
            const analytics = {
                overview: calculateOverviewMetrics(),
                revenue: calculateRevenueAnalytics(),
                services: calculateServiceAnalytics(),
                appointments: calculateAppointmentAnalytics(),
                clients: calculateClientAnalytics(),
                trends: calculateTrendAnalytics()
            };

            dashboardData.analytics = analytics;
            console.log("Analytics generated:", analytics);
        }

        // Calculate Overview Metrics
        function calculateOverviewMetrics() {
            const now = new Date();
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const thisWeek = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);

            return {
                totalAppointments: dashboardData.pastAppointments.length + dashboardData.upcomingAppointments.length,
                completedAppointments: dashboardData.pastAppointments.filter(apt => !apt.canceled).length,
                canceledAppointments: dashboardData.pastAppointments.filter(apt => apt.canceled).length,
                upcomingAppointments: dashboardData.upcomingAppointments.length,
                todayAppointments: dashboardData.upcomingAppointments.filter(apt => 
                    new Date(apt.datetime).toDateString() === today.toDateString()
                ).length,
                thisWeekAppointments: dashboardData.pastAppointments.filter(apt => 
                    new Date(apt.datetime) >= thisWeek && !apt.canceled
                ).length,
                activeServices: dashboardData.services.filter(service => service.active).length,
                totalServices: dashboardData.services.length,
                totalRevenue: dashboardData.pastAppointments
                    .filter(apt => !apt.canceled)
                    .reduce((total, apt) => total + parseFloat(apt.priceSold || apt.price || 0), 0),
                monthlyRevenue: dashboardData.pastAppointments
                    .filter(apt => new Date(apt.datetime) >= thisMonth && !apt.canceled)
                    .reduce((total, apt) => total + parseFloat(apt.priceSold || apt.price || 0), 0),
                cancellationRate: dashboardData.pastAppointments.length > 0 
                    ? (dashboardData.pastAppointments.filter(apt => apt.canceled).length / dashboardData.pastAppointments.length * 100)
                    : 0
            };
        }

        // Calculate Revenue Analytics
        function calculateRevenueAnalytics() {
            const revenueByMonth = {};
            const revenueByService = {};

            dashboardData.pastAppointments
                .filter(apt => !apt.canceled)
                .forEach(apt => {
                    const date = new Date(apt.datetime);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const revenue = parseFloat(apt.priceSold || apt.price || 0);

                    revenueByMonth[monthKey] = (revenueByMonth[monthKey] || 0) + revenue;
                    revenueByService[apt.type] = (revenueByService[apt.type] || 0) + revenue;
                });

            return {
                byMonth: revenueByMonth,
                byService: revenueByService,
                topServices: Object.entries(revenueByService)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5)
            };
        }

        // Calculate Service Analytics
        function calculateServiceAnalytics() {
            const serviceStats = dashboardData.services.map(service => {
                const appointments = [...dashboardData.pastAppointments, ...dashboardData.upcomingAppointments]
                    .filter(apt => apt.appointmentTypeID === service.id && !apt.canceled);

                return {
                    ...service,
                    totalBookings: appointments.length,
                    completedBookings: dashboardData.pastAppointments
                        .filter(apt => apt.appointmentTypeID === service.id && !apt.canceled).length,
                    upcomingBookings: dashboardData.upcomingAppointments
                        .filter(apt => apt.appointmentTypeID === service.id && !apt.canceled).length,
                    averageRevenue: appointments.length > 0 
                        ? service.revenue / appointments.length 
                        : 0
                };
            });

            return {
                all: serviceStats,
                popular: serviceStats.sort((a, b) => b.totalBookings - a.totalBookings).slice(0, 5),
                profitable: serviceStats.sort((a, b) => b.revenue - a.revenue).slice(0, 5)
            };
        }

        // Calculate Appointment Analytics
        function calculateAppointmentAnalytics() {
            const hourlyDistribution = Array(24).fill(0);
            const dayDistribution = Array(7).fill(0);
            const statusDistribution = { completed: 0, canceled: 0, upcoming: 0 };

            [...dashboardData.pastAppointments, ...dashboardData.upcomingAppointments].forEach(apt => {
                const date = new Date(apt.datetime);
                hourlyDistribution[date.getHours()]++;
                dayDistribution[date.getDay()]++;

                if (apt.canceled) {
                    statusDistribution.canceled++;
                } else if (dashboardData.pastAppointments.includes(apt)) {
                    statusDistribution.completed++;
                } else {
                    statusDistribution.upcoming++;
                }
            });

            return {
                hourlyDistribution,
                dayDistribution,
                statusDistribution,
                peakHour: hourlyDistribution.indexOf(Math.max(...hourlyDistribution)),
                peakDay: dayDistribution.indexOf(Math.max(...dayDistribution))
            };
        }

        // Calculate Client Analytics
        function calculateClientAnalytics() {
            const clients = new Map();

            [...dashboardData.pastAppointments, ...dashboardData.upcomingAppointments].forEach(apt => {
                const clientKey = `${apt.firstName} ${apt.lastName}`.trim();
                if (!clients.has(clientKey)) {
                    clients.set(clientKey, {
                        name: clientKey,
                        phone: apt.phone,
                        email: apt.email,
                        appointments: [],
                        totalSpent: 0,
                        lastVisit: null
                    });
                }

                const client = clients.get(clientKey);
                client.appointments.push(apt);
                if (!apt.canceled) {
                    client.totalSpent += parseFloat(apt.priceSold || apt.price || 0);
                }
                if (!client.lastVisit || new Date(apt.datetime) > new Date(client.lastVisit)) {
                    client.lastVisit = apt.datetime;
                }
            });

            const clientArray = Array.from(clients.values());

            return {
                totalClients: clientArray.length,
                topClients: clientArray.sort((a, b) => b.totalSpent - a.totalSpent).slice(0, 10),
                repeatClients: clientArray.filter(client => client.appointments.length > 1).length,
                averageSpentPerClient: clientArray.reduce((sum, client) => sum + client.totalSpent, 0) / clientArray.length || 0
            };
        }

        // Calculate Trend Analytics
        function calculateTrendAnalytics() {
            const monthlyTrends = {};
            const serviceTrends = {};

            [...dashboardData.pastAppointments, ...dashboardData.upcomingAppointments]
                .filter(apt => !apt.canceled)
                .forEach(apt => {
                    const date = new Date(apt.datetime);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

                    if (!monthlyTrends[monthKey]) {
                        monthlyTrends[monthKey] = { appointments: 0, revenue: 0 };
                    }
                    if (!serviceTrends[apt.type]) {
                        serviceTrends[apt.type] = {};
                    }
                    if (!serviceTrends[apt.type][monthKey]) {
                        serviceTrends[apt.type][monthKey] = 0;
                    }

                    monthlyTrends[monthKey].appointments++;
                    monthlyTrends[monthKey].revenue += parseFloat(apt.priceSold || apt.price || 0);
                    serviceTrends[apt.type][monthKey]++;
                });

            return {
                monthly: monthlyTrends,
                services: serviceTrends
            };
        }

        // Fetch All Data from API
        async function fetchAllData() {
            try {
                console.log("Fetching all data from API...");
                
                const [appointmentTypesResult, appointmentsResult, userDataResult] = await Promise.all([
                    fetchAndStoreAppointmentTypes().catch(e => {
                        console.error("Failed to fetch appointment types:", e);
                        return [];
                    }),
                    fetchAndStoreAppointments().catch(e => {
                        console.error("Failed to fetch appointments:", e);
                        return { pastAppointments: [], upcomingAppointments: [] };
                    }),
                    fetchAndStoreUserData().catch(e => {
                        console.error("Failed to fetch user data:", e);
                        return {};
                    })
                ]);

                console.log("All data fetched successfully");
                return true;
            } catch (error) {
                console.error("Error in fetchAllData:", error);
                throw error;
            }
        }

        // Render Complete Dashboard
        function renderDashboard() {
            const mainContent = document.querySelector('main');
            if (mainContent) {
                mainContent.innerHTML = `
                    <div class="max-w-7xl mx-auto space-y-8 animate-fade-in">
                        <!-- Header Section -->
                        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-900 mb-2">Analytics Dashboard</h1>
                                <p class="text-gray-600">Comprehensive insights for ${dashboardData.userData.name || 'your business'}</p>
                            </div>
                            <div class="mt-4 lg:mt-0 flex items-center space-x-3">
                                <button onclick="refreshDashboard()" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors duration-200">
                                    <span class="material-icons text-sm mr-2">refresh</span>
                                    Refresh Data
                                </button>
                                <button class="inline-flex items-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 transition-colors duration-200">
                                    <span class="material-icons text-sm mr-2">download</span>
                                    Export Report
                                </button>
                            </div>
                        </div>

                        <!-- Key Metrics Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="keyMetrics">
                            <!-- Metrics will be inserted here -->
                        </div>

                        <!-- Charts Section -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Revenue Chart -->
                            <div class="bg-white rounded-xl shadow-card border border-gray-100 p-6">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-lg font-semibold text-gray-800">Revenue Overview</h3>
                                    <select id="revenueChartPeriod" class="text-sm border border-gray-300 rounded-lg px-3 py-1">
                                        <option value="6months">Last 6 Months</option>
                                        <option value="12months">Last 12 Months</option>
                                        <option value="all">All Time</option>
                                    </select>
                                </div>
                                <div class="chart-container">
                                    <canvas id="revenueChart"></canvas>
                                </div>
                            </div>

                            <!-- Service Performance Chart -->
                            <div class="bg-white rounded-xl shadow-card border border-gray-100 p-6">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-lg font-semibold text-gray-800">Service Performance</h3>
                                    <div class="text-sm text-gray-500">Top 5 Services</div>
                                </div>
                                <div class="chart-container">
                                    <canvas id="serviceChart"></canvas>
                                </div>
                            </div>

                            <!-- Appointment Status Distribution -->
                            <div class="bg-white rounded-xl shadow-card border border-gray-100 p-6">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-lg font-semibold text-gray-800">Appointment Status</h3>
                                    <div class="text-sm text-gray-500">Overall Distribution</div>
                                </div>
                                <div class="chart-container">
                                    <canvas id="statusChart"></canvas>
                                </div>
                            </div>

                            <!-- Peak Hours Chart -->
                            <div class="bg-white rounded-xl shadow-card border border-gray-100 p-6">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-lg font-semibold text-gray-800">Peak Booking Hours</h3>
                                    <div class="text-sm text-gray-500">24-Hour Distribution</div>
                                </div>
                                <div class="chart-container">
                                    <canvas id="hoursChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Detailed Sections -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Top Services -->
                            <div class="bg-white rounded-xl shadow-card border border-gray-100 overflow-hidden">
                                <div class="px-6 py-4 border-b border-gray-100">
                                    <h3 class="text-lg font-semibold text-gray-800">Top Services</h3>
                                </div>
                                <div id="topServices" class="divide-y divide-gray-100">
                                    <!-- Top services will be inserted here -->
                                </div>
                            </div>

                            <!-- Recent Appointments -->
                            <div class="bg-white rounded-xl shadow-card border border-gray-100 overflow-hidden">
                                <div class="px-6 py-4 border-b border-gray-100">
                                    <h3 class="text-lg font-semibold text-gray-800">Recent Activity</h3>
                                </div>
                                <div id="recentActivity" class="divide-y divide-gray-100">
                                    <!-- Recent activity will be inserted here -->
                                </div>
                            </div>

                            <!-- Top Clients -->
                            <div class="bg-white rounded-xl shadow-card border border-gray-100 overflow-hidden">
                                <div class="px-6 py-4 border-b border-gray-100">
                                    <h3 class="text-lg font-semibold text-gray-800">Top Clients</h3>
                                </div>
                                <div id="topClients" class="divide-y divide-gray-100">
                                    <!-- Top clients will be inserted here -->
                                </div>
                            </div>
                        </div>

                        <!-- Upcoming Appointments -->
                        <div class="bg-white rounded-xl shadow-card border border-gray-100">
                            <div class="px-6 py-4 border-b border-gray-100">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-semibold text-gray-800">Upcoming Appointments</h3>
                                    <span class="bg-primary-100 text-primary-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
                                        ${dashboardData.upcomingAppointments.length} appointments
                                    </span>
                                </div>
                            </div>
                            <div id="upcomingAppointments" class="divide-y divide-gray-100">
                                <!-- Upcoming appointments will be inserted here -->
                            </div>
                        </div>
                    </div>
                `;
            }

            // Render individual sections
            renderKeyMetrics();
            renderTopServices();
            renderRecentActivity();
            renderTopClients();
            renderUpcomingAppointments();
        }

        // Render Key Metrics
        function renderKeyMetrics() {
            const container = document.getElementById('keyMetrics');
            const metrics = dashboardData.analytics.overview;

            const metricCards = [
                {
                    title: 'Total Revenue',
                    value: `$${metrics.totalRevenue.toFixed(2)}`,
                    icon: 'attach_money',
                    color: 'bg-gradient-to-r from-green-500 to-green-600',
                    subtitle: `$${metrics.monthlyRevenue.toFixed(2)} this month`
                },
                {
                    title: 'Total Appointments',
                    value: metrics.totalAppointments.toString(),
                    icon: 'event',
                    color: 'bg-gradient-to-r from-blue-500 to-blue-600',
                    subtitle: `${metrics.todayAppointments} today`
                },
                {
                    title: 'Active Services',
                    value: `${metrics.activeServices}/${metrics.totalServices}`,
                    icon: 'spa',
                    color: 'bg-gradient-to-r from-purple-500 to-purple-600',
                    subtitle: 'services available'
                },
                {
                    title: 'Cancellation Rate',
                    value: `${metrics.cancellationRate.toFixed(1)}%`,
                    icon: 'cancel',
                    color: metrics.cancellationRate > 15 ? 'bg-gradient-to-r from-red-500 to-red-600' : 'bg-gradient-to-r from-orange-500 to-orange-600',
                    subtitle: `${metrics.canceledAppointments} canceled`
                }
            ];

            container.innerHTML = metricCards.map(metric => `
                <div class="relative overflow-hidden rounded-xl ${metric.color} text-white">
                    <div class="p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-white/80 text-sm font-medium">${metric.title}</p>
                                <p class="text-3xl font-bold mt-2">${metric.value}</p>
                                <p class="text-white/70 text-xs mt-1">${metric.subtitle}</p>
                            </div>
                            <div class="p-3 bg-white/20 rounded-lg">
                                <span class="material-icons text-2xl">${metric.icon}</span>
                            </div>
                        </div>
                    </div>
                    <div class="absolute bottom-0 left-0 right-0 h-1 bg-white/30"></div>
                </div>
            `).join('');
        }

        // Render Top Services
        function renderTopServices() {
            const container = document.getElementById('topServices');
            const services = dashboardData.analytics.services.popular.slice(0, 5);

            container.innerHTML = services.map((service, index) => `
                <div class="p-4 hover:bg-gray-50 transition-colors">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background-color: ${service.color}20">
                                    <span class="material-icons text-sm" style="color: ${service.color}">spa</span>
                                </div>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">${service.name}</p>
                                <p class="text-xs text-gray-500">${service.totalBookings} bookings</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-semibold text-gray-900">$${service.revenue.toFixed(2)}</p>
                            <p class="text-xs text-gray-500">${service.duration} min</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Render Recent Activity
        function renderRecentActivity() {
            const container = document.getElementById('recentActivity');
            const recentAppointments = [...dashboardData.pastAppointments, ...dashboardData.upcomingAppointments]
                .sort((a, b) => new Date(b.datetimeCreated) - new Date(a.datetimeCreated))
                .slice(0, 5);

            container.innerHTML = recentAppointments.map(apt => {
                const isPast = new Date(apt.datetime) < new Date();
                const actionText = isPast ? (apt.canceled ? 'cancelled' : 'completed') : 'scheduled';
                const iconName = isPast ? (apt.canceled ? 'cancel' : 'check_circle') : 'event';
                const iconColor = isPast ? (apt.canceled ? 'text-red-500' : 'text-green-500') : 'text-blue-500';

                return `
                    <div class="p-4 hover:bg-gray-50 transition-colors">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0">
                                <span class="material-icons ${iconColor} text-lg">${iconName}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-gray-900">
                                    <span class="font-medium">${apt.firstName} ${apt.lastName}</span> 
                                    ${actionText} <span class="font-medium">${apt.type}</span>
                                </p>
                                <p class="text-xs text-gray-500 mt-1">${formatRelativeTime(new Date(apt.datetimeCreated))}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render Top Clients
        function renderTopClients() {
            const container = document.getElementById('topClients');
            const clients = dashboardData.analytics.clients.topClients.slice(0, 5);

            container.innerHTML = clients.map(client => `
                <div class="p-4 hover:bg-gray-50 transition-colors">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center text-primary-600 font-semibold text-sm">
                                    ${client.name.split(' ').map(n => n[0]).join('').toUpperCase()}
                                </div>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">${client.name}</p>
                                <p class="text-xs text-gray-500">${client.appointments.length} appointments</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-semibold text-gray-900">$${client.totalSpent.toFixed(2)}</p>
                            <p class="text-xs text-gray-500">total spent</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Render Upcoming Appointments
        function renderUpcomingAppointments() {
            const container = document.getElementById('upcomingAppointments');
            const upcoming = dashboardData.upcomingAppointments
                .filter(apt => !apt.canceled)
                .sort((a, b) => new Date(a.datetime) - new Date(b.datetime))
                .slice(0, 10);

            if (!upcoming.length) {
                container.innerHTML = `
                    <div class="p-8 text-center">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                            <span class="material-icons text-gray-400 text-2xl">event_available</span>
                        </div>
                        <h3 class="text-sm font-medium text-gray-900 mb-1">No upcoming appointments</h3>
                        <p class="text-sm text-gray-500">New appointments will appear here</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = upcoming.map(apt => {
                const appointmentDate = new Date(apt.datetime);
                const isToday = appointmentDate.toDateString() === new Date().toDateString();
                const isTomorrow = appointmentDate.toDateString() === new Date(Date.now() + 86400000).toDateString();
                
                let dateLabel = formatDate(apt.datetime);
                if (isToday) dateLabel = 'Today';
                else if (isTomorrow) dateLabel = 'Tomorrow';

                const service = dashboardData.services.find(s => s.id === apt.appointmentTypeID);

                return `
                    <div class="p-4 hover:bg-gray-50 transition-colors">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3 flex-1">
                                <div class="flex-shrink-0">
                                    <div class="w-12 h-12 rounded-lg flex items-center justify-center" style="background-color: ${service?.color || '#6b7280'}20">
                                        <span class="material-icons text-lg" style="color: ${service?.color || '#6b7280'}">person</span>
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h5 class="text-sm font-semibold text-gray-900">${apt.firstName} ${apt.lastName}</h5>
                                    <div class="flex items-center space-x-2 mt-1">
                                        <span class="service-badge bg-gray-100 text-gray-800">${apt.type}</span>
                                        ${apt.phone ? `<span class="text-xs text-gray-500">${apt.phone}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-medium text-gray-900">${dateLabel}</p>
                                <p class="text-xs text-gray-500">${apt.time} - ${apt.endTime}</p>
                                ${service?.duration ? `<p class="text-xs text-gray-400">${service.duration} min</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Initialize Charts
        function initializeCharts() {
            initializeRevenueChart();
            initializeServiceChart();
            initializeStatusChart();
            initializeHoursChart();
        }

        // Initialize Revenue Chart
        function initializeRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            const revenueData = dashboardData.analytics.revenue.byMonth;
            
            const labels = Object.keys(revenueData).sort();
            const data = labels.map(label => revenueData[label]);

            analyticsConfig.charts.revenue = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.map(label => {
                        const [year, month] = label.split('-');
                        return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Revenue',
                        data: data,
                        borderColor: analyticsConfig.colors.primary,
                        backgroundColor: analyticsConfig.colors.primary + '20',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Initialize Service Chart
        function initializeServiceChart() {
            const ctx = document.getElementById('serviceChart').getContext('2d');
            const serviceData = dashboardData.analytics.services.popular.slice(0, 5);
            
            analyticsConfig.charts.service = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: serviceData.map(s => s.name),
                    datasets: [{
                        data: serviceData.map(s => s.totalBookings),
                        backgroundColor: [
                            analyticsConfig.colors.primary,
                            analyticsConfig.colors.success,
                            analyticsConfig.colors.warning,
                            analyticsConfig.colors.purple,
                            analyticsConfig.colors.teal
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // Initialize Status Chart
        function initializeStatusChart() {
            const ctx = document.getElementById('statusChart').getContext('2d');
            const statusData = dashboardData.analytics.appointments.statusDistribution;
            
            analyticsConfig.charts.status = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Completed', 'Upcoming', 'Canceled'],
                    datasets: [{
                        data: [statusData.completed, statusData.upcoming, statusData.canceled],
                        backgroundColor: [
                            analyticsConfig.colors.success,
                            analyticsConfig.colors.primary,
                            analyticsConfig.colors.danger
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // Initialize Hours Chart
        function initializeHoursChart() {
            const ctx = document.getElementById('hoursChart').getContext('2d');
            const hourlyData = dashboardData.analytics.appointments.hourlyDistribution;
            
            analyticsConfig.charts.hours = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => {
                        const hour = i === 0 ? 12 : i > 12 ? i - 12 : i;
                        const ampm = i < 12 ? 'AM' : 'PM';
                        return `${hour}${ampm}`;
                    }),
                    datasets: [{
                        label: 'Appointments',
                        data: hourlyData,
                        backgroundColor: analyticsConfig.colors.primary + '80',
                        borderColor: analyticsConfig.colors.primary,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Utility Functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        function formatRelativeTime(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            return `${Math.floor(diffInSeconds / 86400)}d ago`;
        }

        // Loading and Error States
        function showLoadingState() {
            const mainContent = document.querySelector('main');
            if (mainContent) {
                mainContent.innerHTML = `
                    <div class="flex items-center justify-center h-64">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto mb-4"></div>
                            <span class="text-gray-600">Loading analytics dashboard...</span>
                        </div>
                    </div>
                `;
            }
        }

        function showErrorState() {
            const mainContent = document.querySelector('main');
            if (mainContent) {
                mainContent.innerHTML = `
                    <div class="text-center py-12">
                        <span class="material-icons text-gray-300 text-6xl mb-4">error_outline</span>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Unable to load dashboard</h3>
                        <p class="text-gray-500 mb-4">There was an error loading your analytics data.</p>
                        <button onclick="location.reload()" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        // Refresh Dashboard
        async function refreshDashboard() {
            try {
                showLoadingState();
                await fetchAllData();
                await loadAndProcessData();
                renderDashboard();
                
                // Destroy existing charts before recreating
                Object.values(analyticsConfig.charts).forEach(chart => {
                    if (chart && typeof chart.destroy === 'function') {
                        chart.destroy();
                    }
                });
                analyticsConfig.charts = {};
                
                initializeCharts();
            } catch (error) {
                console.error("Error refreshing dashboard:", error);
                showErrorState();
            }
        }

        // API Fetch Functions
        function fetchAndStoreAppointmentTypes() {
            const requestData = {
                crmAPIRequest: { 
                    type: 1 // Type 1 for appointment types
                }
            };
            
            return ZOHO.CRM.FUNCTIONS.execute("acuityscheduling1__apihandler", requestData)
                .then(function(data) {
                    try {
                        console.log("Raw response from Zoho function for appointment types:", data);
                        
                        if (data.code === "INVALID_DATA" || data.code === "ERROR") {
                            throw new Error(data.message || "Error from Zoho function");
                        }
                        
                        if (!data.details || !data.details.output) {
                            throw new Error("Invalid response structure from Zoho function");
                        }
                        
                        const outputData = JSON.parse(data.details.output);
                        
                        if (outputData.status_code !== 200) {
                            throw new Error(`API returned status code ${outputData.status_code}`);
                        }
                        
                        if (!outputData.response) {
                            throw new Error("No response data found");
                        }
                        
                        const appointmentTypes = JSON.parse(outputData.response);
                        localStorage.setItem('appointmentTypes', JSON.stringify(appointmentTypes));
                        console.log("Appointment types stored successfully", appointmentTypes);
                        
                        return appointmentTypes;
                    } catch (error) {
                        console.error("Error processing appointment types:", error);
                        throw error;
                    }
                })
                .catch(function(error) {
                    console.error("Error fetching appointment types:", error);
                    throw error;
                });
        }
        
        function fetchAndStoreAppointments() {
            const requestData = {
                crmAPIRequest: { 
                    type: 2 // Type 2 for appointments
                }
            };
            
            return ZOHO.CRM.FUNCTIONS.execute("acuityscheduling1__apihandler", requestData)
                .then(function(data) {
                    try {
                        console.log("Raw response from Zoho function for appointments:", data);
                        
                        if (data.code === "INVALID_DATA" || data.code === "ERROR") {
                            throw new Error(data.message || "Error from Zoho function");
                        }
                        
                        if (!data.details || !data.details.output) {
                            throw new Error("Invalid response structure from Zoho function");
                        }
                        
                        const outputData = JSON.parse(data.details.output);
                        
                        if (outputData.status_code !== 200) {
                            throw new Error(`API returned status code ${outputData.status_code}`);
                        }
                        
                        if (!outputData.response) {
                            throw new Error("No response data found");
                        }
                        
                        const appointments = JSON.parse(outputData.response);
                        
                        // Separate past and upcoming appointments
                        const now = new Date();
                        const pastAppointments = [];
                        const upcomingAppointments = [];
                        
                        appointments.forEach(appointment => {
                            const appointmentDate = new Date(appointment.datetime);
                            if (appointmentDate < now) {
                                pastAppointments.push(appointment);
                            } else {
                                upcomingAppointments.push(appointment);
                            }
                        });
                        
                        // Store in localStorage
                        localStorage.setItem('pastAppointments', JSON.stringify(pastAppointments));
                        localStorage.setItem('upcomingAppointments', JSON.stringify(upcomingAppointments));
                        console.log("Appointments stored successfully", { past: pastAppointments, upcoming: upcomingAppointments });
                        
                        return { pastAppointments, upcomingAppointments };
                    } catch (error) {
                        console.error("Error processing appointments:", error);
                        throw error;
                    }
                })
                .catch(function(error) {
                    console.error("Error fetching appointments:", error);
                    throw error;
                });
        }
        
        function fetchAndStoreUserData() {
            const requestData = {
                crmAPIRequest: { 
                    type: 3 // Type 3 for GetMe
                }
            };
            
            return ZOHO.CRM.FUNCTIONS.execute("acuityscheduling1__apihandler", requestData)
                .then(function(data) {
                    try {
                        console.log("Raw response from Zoho function for user data:", data);
                        
                        if (data.code === "INVALID_DATA" || data.code === "ERROR") {
                            throw new Error(data.message || "Error from Zoho function");
                        }
                        
                        if (!data.details || !data.details.output) {
                            throw new Error("Invalid response structure from Zoho function");
                        }
                        
                        const outputData = JSON.parse(data.details.output);
                        
                        if (outputData.status_code !== 200) {
                            throw new Error(`API returned status code ${outputData.status_code}`);
                        }
                        
                        if (!outputData.response) {
                            throw new Error("No response data found");
                        }
                        
                        const userData = JSON.parse(outputData.response);
                        localStorage.setItem('userData', JSON.stringify(userData));
                        console.log("User data stored successfully", userData);
                        
                        return userData;
                    } catch (error) {
                        console.error("Error processing user data:", error);
                        throw error;
                    }
                })
                .catch(function(error) {
                    console.error("Error fetching user data:", error);
                    throw error;
                });
        }

        // Export Functions
        function exportDashboardReport() {
            const reportData = {
                generatedOn: new Date().toISOString(),
                businessName: dashboardData.userData.name,
                period: 'All Time',
                overview: dashboardData.analytics.overview,
                topServices: dashboardData.analytics.services.popular.slice(0, 10),
                topClients: dashboardData.analytics.clients.topClients.slice(0, 10),
                revenueAnalytics: dashboardData.analytics.revenue
            };

            const dataStr = JSON.stringify(reportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `dashboard-report-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Quick Action Functions
        function viewAllAppointmentTypes() {
            window.location.href = 'appointment_types.html';
        }

        function viewAllUpcoming() {
            window.location.href = 'appointments.html?type=upcoming';
        }

        function viewAllPast() {
            window.location.href = 'appointments.html?type=past';
        }

        // Mobile responsive enhancements
        function adjustMobileLayout() {
            const isMobile = window.innerWidth < 1024;
            
            if (isMobile) {
                // Adjust chart containers for mobile
                document.querySelectorAll('.chart-container').forEach(container => {
                    container.style.height = '250px';
                });
                
                // Adjust grid layouts for mobile
                const keyMetrics = document.getElementById('keyMetrics');
                if (keyMetrics) {
                    keyMetrics.className = 'grid grid-cols-1 sm:grid-cols-2 gap-4';
                }
            }
        }

        // Event Listeners
        window.addEventListener('resize', adjustMobileLayout);
        window.addEventListener('load', adjustMobileLayout);

        // Chart period change handler
        document.addEventListener('change', function(e) {
            if (e.target.id === 'revenueChartPeriod') {
                updateRevenueChart(e.target.value);
            }
        });

        function updateRevenueChart(period) {
            if (analyticsConfig.charts.revenue) {
                analyticsConfig.charts.revenue.destroy();
            }
            initializeRevenueChart();
        }
    </script>
</head>
<body class="bg-gray-50 font-sans text-gray-800 antialiased min-h-screen">
    <div class="flex h-screen overflow-hidden">
        <!-- Enhanced Sidebar -->
        <div class="hidden lg:flex lg:flex-shrink-0">
            <div class="flex flex-col w-64 bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 shadow-2xl">
                <div class="flex items-center justify-center h-16 px-6 bg-gray-900/80 backdrop-blur-sm border-b border-gray-700/50">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-r from-primary-500 to-primary-600 flex items-center justify-center shadow-lg">
                            <span class="material-icons text-white text-xl">spa</span>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-white tracking-tight">Bio Revive</h2>
                            <p class="text-xs text-gray-400">by SkinEnvy</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex-1 flex flex-col pt-6 pb-4 overflow-y-auto scrollbar-hide">
                    <div class="px-4">
                        <h3 class="text-xs font-semibold uppercase tracking-wider text-gray-400 mb-3">Analytics</h3>
                    </div>
                    <nav class="mt-1 flex-1 px-2 space-y-1">
                        <a href="#" class="group flex items-center px-4 py-3 text-sm font-medium rounded-xl bg-gradient-to-r from-primary-600 to-primary-700 text-white shadow-lg border-l-4 border-primary-300 transition-all duration-200">
                            <span class="material-icons mr-3 text-white">dashboard</span>
                            Analytics Dashboard
                        </a>
                        <a href="appointments.html" class="group flex items-center px-4 py-3 text-sm font-medium rounded-xl text-gray-300 hover:bg-gray-800 hover:text-white transition-all duration-200">
                            <span class="material-icons mr-3 text-gray-400 group-hover:text-white">event</span>
                            Appointments
                        </a>
                        <a href="appointment_types.html" class="group flex items-center px-4 py-3 text-sm font-medium rounded-xl text-gray-300 hover:bg-gray-800 hover:text-white transition-all duration-200">
                            <span class="material-icons mr-3 text-gray-400 group-hover:text-white">spa</span>
                            Services
                        </a>
                        <a href="#" class="group flex items-center px-4 py-3 text-sm font-medium rounded-xl text-gray-300 hover:bg-gray-800 hover:text-white transition-all duration-200">
                            <span class="material-icons mr-3 text-gray-400 group-hover:text-white">people</span>
                            Clients
                        </a>
                        <a href="#" class="group flex items-center px-4 py-3 text-sm font-medium rounded-xl text-gray-300 hover:bg-gray-800 hover:text-white transition-all duration-200">
                            <span class="material-icons mr-3 text-gray-400 group-hover:text-white">analytics</span>
                            Reports
                        </a>
                    </nav>

                    <div class="px-4 mt-8">
                        <h3 class="text-xs font-semibold uppercase tracking-wider text-gray-400 mb-3">Settings</h3>
                    </div>
                    <nav class="mt-1 flex-1 px-2 space-y-1">
                        <a href="#" class="group flex items-center px-4 py-3 text-sm font-medium rounded-xl text-gray-300 hover:bg-gray-800 hover:text-white transition-all duration-200">
                            <span class="material-icons mr-3 text-gray-400 group-hover:text-white">person</span>
                            Profile
                        </a>
                        <a href="#" class="group flex items-center px-4 py-3 text-sm font-medium rounded-xl text-gray-300 hover:bg-gray-800 hover:text-white transition-all duration-200">
                            <span class="material-icons mr-3 text-gray-400 group-hover:text-white">settings</span>
                            Settings
                        </a>
                        <a href="#" class="group flex items-center px-4 py-3 text-sm font-medium rounded-xl text-gray-300 hover:bg-gray-800 hover:text-white transition-all duration-200">
                            <span class="material-icons mr-3 text-gray-400 group-hover:text-white">help</span>
                            Help & Support
                        </a>
                    </nav>
                </div>
                
                <!-- User Profile Section -->
                <div class="p-4 bg-gray-900/70 backdrop-blur-sm border-t border-gray-700/50">
                    <div id="userProfile" class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center text-primary-600 font-semibold">
                            PK
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-white truncate">Prem Anand K</p>
                            <div class="flex items-center mt-1">
                                <div class="h-2 w-2 rounded-full bg-green-400 mr-1.5"></div>
                                <p class="text-xs text-gray-400">Online</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex flex-col flex-1 overflow-hidden">
            <!-- Enhanced Top Navigation -->
            <div class="flex items-center justify-between h-16 bg-white border-b border-gray-200 px-4 md:px-6 lg:px-8 shadow-sm sticky top-0 z-10">
                <button class="p-2 rounded-md text-gray-500 lg:hidden hover:bg-gray-100">
                    <span class="material-icons">menu</span>
                </button>
                
                <div class="flex-1 flex justify-center lg:justify-end max-w-lg ml-auto">
                    <div class="w-full">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="material-icons text-gray-400">search</span>
                            </div>
                            <input type="text" placeholder="Search analytics, clients, services..." class="block w-full pl-10 pr-3 py-2 rounded-lg border border-gray-300 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-150">
                        </div>
                    </div>
                </div>
                
                <div class="ml-4 flex items-center space-x-3">
                    <button class="p-2 rounded-full text-gray-400 hover:text-gray-500 hover:bg-gray-100 relative transition-colors">
                        <span class="material-icons">notifications</span>
                        <span class="absolute top-0 right-0 block h-2.5 w-2.5 rounded-full bg-red-500 ring-2 ring-white"></span>
                    </button>
                    <button onclick="refreshDashboard()" class="p-2 rounded-full text-gray-400 hover:text-gray-500 hover:bg-gray-100 transition-colors" title="Refresh Dashboard">
                        <span class="material-icons">refresh</span>
                    </button>
                    <button onclick="exportDashboardReport()" class="p-2 rounded-full text-gray-400 hover:text-gray-500 hover:bg-gray-100 transition-colors" title="Export Report">
                        <span class="material-icons">download</span>
                    </button>
                    <button class="p-2 rounded-full text-gray-400 hover:text-gray-500 hover:bg-gray-100 transition-colors">
                        <span class="material-icons">help_outline</span>
                    </button>
                </div>
            </div>

            <!-- Page Content -->
            <main class="flex-1 overflow-auto p-4 md:p-6 lg:p-8 bg-gray-50">
                <!-- Content will be dynamically inserted here -->
            </main>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <div class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-4 py-2 z-50">
        <div class="flex justify-around items-center">
            <a href="#" class="flex flex-col items-center p-2 text-primary-600">
                <span class="material-icons text-xl">dashboard</span>
                <span class="text-xs mt-1">Analytics</span>
            </a>
            <a href="appointments.html" class="flex flex-col items-center p-2 text-gray-500">
                <span class="material-icons text-xl">event</span>
                <span class="text-xs mt-1">Appointments</span>
            </a>
            <a href="appointment_types.html" class="flex flex-col items-center p-2 text-gray-500">
                <span class="material-icons text-xl">spa</span>
                <span class="text-xs mt-1">Services</span>
            </a>
            <a href="#" class="flex flex-col items-center p-2 text-gray-500">
                <span class="material-icons text-xl">person</span>
                <span class="text-xs mt-1">Profile</span>
            </a>
        </div>
    </div>

    <!-- Enhanced Quick Actions Floating Button -->
    <div class="fixed bottom-20 lg:bottom-6 right-6 z-40">
        <div class="relative">
            <button id="quickActionsBtn" class="w-14 h-14 bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 rounded-full shadow-xl flex items-center justify-center text-white transition-all duration-200 hover:shadow-2xl hover:scale-105">
                <span class="material-icons text-2xl">add</span>
            </button>
            
            <!-- Quick Actions Menu -->
            <div id="quickActionsMenu" class="absolute bottom-16 right-0 bg-white rounded-xl shadow-2xl border border-gray-200 py-2 min-w-48 hidden">
                <a href="#" class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                    <span class="material-icons text-sm mr-3 text-primary-600">event</span>
                    New Appointment
                </a>
                <a href="#" class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                    <span class="material-icons text-sm mr-3 text-emerald-600">spa</span>
                    New Service
                </a>
                <a href="#" class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                    <span class="material-icons text-sm mr-3 text-blue-600">person_add</span>
                    New Client
                </a>
                <div class="border-t border-gray-100 my-1"></div>
                <a href="#" onclick="exportDashboardReport()" class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                    <span class="material-icons text-sm mr-3 text-purple-600">analytics</span>
                    Export Analytics
                </a>
            </div>
        </div>
    </div>

    <script>
        // Quick actions menu toggle
        document.addEventListener('DOMContentLoaded', function() {
            const quickActionsBtn = document.getElementById('quickActionsBtn');
            const quickActionsMenu = document.getElementById('quickActionsMenu');
            
            if (quickActionsBtn && quickActionsMenu) {
                quickActionsBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    quickActionsMenu.classList.toggle('hidden');
                });

                // Close menu when clicking outside
                document.addEventListener('click', function() {
                    quickActionsMenu.classList.add('hidden');
                });

                quickActionsMenu.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        });
    </script>
</body>
</html>